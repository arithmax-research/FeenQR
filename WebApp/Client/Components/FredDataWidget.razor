@using System.Net.Http
@using System.Text.Json
@using System.Net.Http.Json
@inject HttpClient Http
@inject IJSRuntime JS

<div class="fred-widget">
    <div class="widget-controls">
        <div class="control-group">
            <label>Quick Access:</label>
            <button class="btn btn-primary" @onclick="LoadPopularSeries">
                <i class="fas fa-star"></i> Popular Series
            </button>
        </div>
        
        <div class="control-group">
            <label>Search:</label>
            <input type="text" class="form-control" @bind="searchQuery" placeholder="Search FRED indicators..." />
            <button class="btn btn-success" @onclick="SearchFred">
                <i class="fas fa-search"></i> Search
            </button>
        </div>

        <div class="control-group">
            <label>Series ID:</label>
            <input type="text" class="form-control" @bind="seriesId" placeholder="e.g., GDP, UNRATE, DFF" />
            <button class="btn btn-info" @onclick="LoadSeries">
                <i class="fas fa-download"></i> Load & Analyze
            </button>
        </div>
    </div>

    @if (isLoading)
    {
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i> Loading FRED data...
        </div>
    }
    else if (errorMessage != null)
    {
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle"></i> @errorMessage
        </div>
    }
    else if (fredData != null)
    {
        <div class="data-container">
            <!-- Chart Visualization -->
            <div class="chart-section">
                <h4><i class="fas fa-chart-line"></i> @seriesId Data Visualization</h4>
                @if (chartDataPoints != null && chartDataPoints.Any())
                {
                    <canvas id="fredChart_@chartId" style="height: 400px; width: 100%;"></canvas>
                }
                else
                {
                    <div class="chart-placeholder">
                        <p>Chart data processing...</p>
                        <small>Showing recent observations for @seriesId</small>
                    </div>
                }
            </div>

            <!-- Data Summary -->
            <div class="data-summary">
                <h5><i class="fas fa-info-circle"></i> Data Summary</h5>
                @if (chartDataPoints != null && chartDataPoints.Any())
                {
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-label">Latest Value:</span>
                            <span class="stat-value">@chartDataPoints.Last().Value.ToString("N2")</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Date Range:</span>
                            <span class="stat-value">@chartDataPoints.First().Date to @chartDataPoints.Last().Date</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Data Points:</span>
                            <span class="stat-value">@chartDataPoints.Count</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Average:</span>
                            <span class="stat-value">@chartDataPoints.Average(d => d.Value).ToString("N2")</span>
                        </div>
                    </div>
                }
            </div>

            <!-- AI Analysis -->
            @if (aiAnalysis != null)
            {
                <div class="ai-analysis-section">
                    <h4><i class="fas fa-brain"></i> AI Analysis</h4>
                    <div class="analysis-content">
                        @((MarkupString)aiAnalysis.Replace("\n", "<br/>"))
                    </div>
                </div>
            }
            else if (isAnalyzing)
            {
                <div class="ai-analysis-section">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner fa-spin"></i> Analyzing data with AI...
                    </div>
                </div>
            }

            <!-- Raw Data (Collapsible) -->
            <div class="raw-data-section">
                <button class="btn btn-secondary" @onclick="() => showRawData = !showRawData">
                    <i class="fas @(showRawData ? "fa-chevron-up" : "fa-chevron-down")"></i> 
                    @(showRawData ? "Hide" : "Show") Raw Data
                </button>
                @if (showRawData)
                {
                    <pre>@JsonSerializer.Serialize(fredData.Value, new JsonSerializerOptions { WriteIndented = true })</pre>
                }
            </div>
        </div>
    }
</div>

<style>
    .fred-widget {
        background: #000000;
        border-radius: 10px;
        padding: 25px;
        box-shadow: 0 2px 10px rgba(255,255,255,0.1);
    }

    .widget-header h3 {
        color: #ffffff;
        margin-bottom: 10px;
    }

    .widget-header p {
        color: #bdbdbd;
        margin-bottom: 20px;
    }

    .widget-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .control-group label {
        min-width: 100px;
        font-weight: 600;
        color: #ffffff;
    }

    .control-group input {
        flex: 1;
    }

    .data-display {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
        margin-top: 20px;
    }

    .data-display pre {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        max-height: 500px;
    }

    .loading-spinner {
        text-align: center;
        padding: 40px;
        color: #3498db;
        font-size: 1.2rem;
    }

    .data-container {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .chart-section {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
    }

    .chart-section h4 {
        color: #ffffff;
        margin-bottom: 15px;
    }

    .chart-placeholder {
        padding: 60px 20px;
        text-align: center;
        color: #bdbdbd;
        font-size: 1.2rem;
    }

    .data-summary {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
    }

    .data-summary h5 {
        color: #ffffff;
        margin-bottom: 15px;
    }

    .summary-stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }

    .stat-item {
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .stat-label {
        color: #bdbdbd;
        font-size: 0.9rem;
    }

    .stat-value {
        color: #ffffff;
        font-size: 1.2rem;
        font-weight: 600;
    }

    .ai-analysis-section {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
    }

    .ai-analysis-section h4 {
        color: #ffffff;
        margin-bottom: 15px;
    }

    .analysis-content {
        color: #bdbdbd;
        line-height: 1.8;
        font-size: 1rem;
    }

    .raw-data-section {
        background: #1e1e1e;
        border-radius: 8px;
        padding: 20px;
    }

    .raw-data-section pre {
        background: #2c3e50;
        color: #ecf0f1;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
        max-height: 400px;
        margin-top: 10px;
    }
</style>

@code {
    private string searchQuery = "";
    private string seriesId = "GDP";
    private bool isLoading = false;
    private bool isAnalyzing = false;
    private bool showRawData = false;
    private string? errorMessage = null;
    private JsonElement? fredData = null;
    private string? aiAnalysis = null;
    private string chartId = Guid.NewGuid().ToString().Replace("-", "");
    private List<ChartDataPoint>? chartDataPoints = null;

    private class ChartDataPoint
    {
        public string Date { get; set; } = "";
        public double Value { get; set; }
    }

    private async Task LoadPopularSeries()
    {
        isLoading = true;
        errorMessage = null;
        aiAnalysis = null;
        try
        {
            var response = await Http.GetStringAsync("/api/EconomicData/fred/popular");
            fredData = JsonSerializer.Deserialize<JsonElement>(response);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading popular series: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task SearchFred()
    {
        if (string.IsNullOrWhiteSpace(searchQuery)) return;
        
        isLoading = true;
        errorMessage = null;
        aiAnalysis = null;
        try
        {
            var response = await Http.GetStringAsync($"/api/EconomicData/fred/search?query={Uri.EscapeDataString(searchQuery)}");
            fredData = JsonSerializer.Deserialize<JsonElement>(response);
        }
        catch (Exception ex)
        {
            errorMessage = $"Error searching FRED: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadSeries()
    {
        if (string.IsNullOrWhiteSpace(seriesId)) return;
        
        isLoading = true;
        errorMessage = null;
        aiAnalysis = null;
        chartDataPoints = null;
        try
        {
            var response = await Http.GetStringAsync($"/api/EconomicData/fred/series/{seriesId}");
            fredData = JsonSerializer.Deserialize<JsonElement>(response);
            
            // Parse chart data
            ParseChartData();
            
            StateHasChanged();
            
            // Render chart
            await RenderChart();
            
            // Get AI analysis
            await AnalyzeDataWithAI();
        }
        catch (Exception ex)
        {
            errorMessage = $"Error loading series: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private void ParseChartData()
    {
        try
        {
            if (fredData == null) return;

            chartDataPoints = new List<ChartDataPoint>();
            
            // FRED response structure: { seriesId, source, data: { observations: [...] }, timestamp }
            if (fredData.Value.TryGetProperty("data", out var dataWrapper))
            {
                JsonElement observationsElement;
                
                // Try to get observations array from nested structure
                if (dataWrapper.TryGetProperty("observations", out observationsElement))
                {
                    // Data is wrapped in observations
                    foreach (var obs in observationsElement.EnumerateArray())
                    {
                        if (obs.TryGetProperty("date", out var dateEl) && 
                            obs.TryGetProperty("value", out var valueEl))
                        {
                            var dateStr = dateEl.GetString() ?? "";
                            var valueStr = valueEl.GetString() ?? "0";
                            
                            if (double.TryParse(valueStr, out var value) && !double.IsNaN(value))
                            {
                                chartDataPoints.Add(new ChartDataPoint
                                {
                                    Date = dateStr,
                                    Value = value
                                });
                            }
                        }
                    }
                }
                else if (dataWrapper.ValueKind == JsonValueKind.Array)
                {
                    // Data is directly an array
                    foreach (var obs in dataWrapper.EnumerateArray())
                    {
                        if (obs.TryGetProperty("date", out var dateEl) && 
                            obs.TryGetProperty("value", out var valueEl))
                        {
                            var dateStr = dateEl.GetString() ?? "";
                            var valueStr = valueEl.GetString() ?? "0";
                            
                            if (double.TryParse(valueStr, out var value) && !double.IsNaN(value))
                            {
                                chartDataPoints.Add(new ChartDataPoint
                                {
                                    Date = dateStr,
                                    Value = value
                                });
                            }
                        }
                    }
                }
            }

            Console.WriteLine($"Parsed {chartDataPoints.Count} data points");

            // Take last 50 points for cleaner visualization
            if (chartDataPoints.Count > 50)
            {
                chartDataPoints = chartDataPoints.TakeLast(50).ToList();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error parsing chart data: {ex.Message}");
        }
    }

    private async Task RenderChart()
    {
        try
        {
            if (chartDataPoints == null || !chartDataPoints.Any())
            {
                Console.WriteLine("No chart data points to render");
                return;
            }

            // Small delay to ensure canvas is rendered
            await Task.Delay(100);

            var labels = chartDataPoints.Select(d => d.Date).ToArray();
            var values = chartDataPoints.Select(d => d.Value).ToArray();

            Console.WriteLine($"Rendering chart with {labels.Length} points for {seriesId}");

            await JS.InvokeVoidAsync("renderLineChart", 
                $"fredChart_{chartId}", 
                labels, 
                values, 
                seriesId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error rendering chart: {ex.Message}");
        }
    }

    private async Task AnalyzeDataWithAI()
    {
        try
        {
            isAnalyzing = true;
            StateHasChanged();

            var analyzeRequest = new
            {
                dataSource = "FRED",
                seriesName = seriesId,
                data = JsonSerializer.Serialize(fredData)
            };

            var response = await Http.PostAsJsonAsync("/api/EconomicData/analyze", analyzeRequest);
            var result = await response.Content.ReadAsStringAsync();
            var analysisResult = JsonSerializer.Deserialize<JsonElement>(result);
            
            aiAnalysis = analysisResult.GetProperty("analysis").GetString();
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error getting AI analysis: {ex.Message}");
            aiAnalysis = "AI analysis temporarily unavailable.";
        }
        finally
        {
            isAnalyzing = false;
        }
    }
}
