@using System.Net.Http.Json

<div class="card">
    <div class="card-header">
        <h5 class="card-title">LinkedIn Quant Insider Scraper</h5>
    </div>
    <div class="card-body">
        <div class="mb-3">
            <label for="urlInput" class="form-label">LinkedIn URL</label>
            <input type="url" class="form-control" id="urlInput" @bind="url" placeholder="https://www.linkedin.com/company/quant-insider/posts/?feedView=all&viewAsMember=true" />
        </div>
        <button class="btn btn-primary" @onclick="ScrapePosts" disabled="@isLoading">Scrape Posts</button>

        @if (isLoading)
        {
            <div class="mt-3">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        }

        @if (posts != null && posts.Any())
        {
            <div class="mt-3">
                <h6>Recent Posts</h6>
                @foreach (var post in posts)
                {
                    <div class="card mb-2">
                        <div class="card-body">
                            <h6 class="card-title">@post.Author</h6>
                            <p class="card-text">@post.Content</p>
                            <small class="text-muted">@post.Timestamp</small>
                            @if (post.Papers != null && post.Papers.Any())
                            {
                                <div class="mt-2">
                                    <strong>Papers:</strong>
                                    <ul>
                                        @foreach (var paper in post.Papers)
                                        {
                                            <li>
                                                <a href="@paper.Link" target="_blank">@paper.Title</a>
                                                @if (!string.IsNullOrEmpty(paper.DownloadLink))
                                                {
                                                    <a href="@paper.DownloadLink" class="btn btn-sm btn-outline-primary ms-2" target="_blank">Download</a>
                                                }
                                            </li>
                                        }
                                    </ul>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else if (!isLoading && posts != null && !posts.Any())
        {
            <div class="mt-3 alert alert-info">
                No posts found or unable to scrape.
            </div>
        }
    </div>
</div>

@code {
    private string url = "https://www.linkedin.com/company/quant-insider/posts/?feedView=all&viewAsMember=true";
    private bool isLoading = false;
    private List<LinkedInPost>? posts;

    private async Task ScrapePosts()
    {
        isLoading = true;
        posts = null;

        try
        {
            var requestData = new { Url = url };
            var response = await Http.PostAsJsonAsync("api/linkedin-scrape", requestData);
            if (response.IsSuccessStatusCode)
            {
                posts = await response.Content.ReadFromJsonAsync<List<LinkedInPost>>();
            }
            else
            {
                posts = new List<LinkedInPost>();
            }
        }
        catch (Exception)
        {
            posts = new List<LinkedInPost>();
            // Could show error message
        }

        isLoading = false;
    }

    [Inject]
    private HttpClient Http { get; set; } = default!;

    public class LinkedInPost
    {
        public string? Author { get; set; }
        public string? Content { get; set; }
        public string? Timestamp { get; set; }
        public List<Paper>? Papers { get; set; }
    }

    public class Paper
    {
        public string? Title { get; set; }
        public string? Link { get; set; }
        public string? DownloadLink { get; set; }
    }
}