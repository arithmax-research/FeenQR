@page "/dashboard"
@inject IJSRuntime JS

<PageTitle>FeenQR - Dashboard</PageTitle>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.3.1/dist/gridstack.min.css" />
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gridstack@10.3.1/dist/gridstack-extra.min.css" />

<style>
    .dashboard-container {
        padding: 1.5rem;
        margin-left: 280px;
        background: inherit;
        min-height: 100vh;
        height: 100vh;
        overflow: auto;
        width: calc(100vw - 280px);
        box-sizing: border-box;
    }

    .grid-stack {
        background: transparent;
        min-height: calc(100vh - 3rem);
        width: 100%;
        height: 100%;
    }

    .grid-stack-item-content {
        background: rgba(18, 18, 18, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.08);
        border-radius: 12px;
        padding: 0;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.4);
        height: 100%;
    }

    .widget-header {
        font-size: 0.9rem;
        font-weight: 600;
        padding: 1rem 1.25rem;
        color: #f9fafb;
        background: rgba(255, 255, 255, 0.02);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        cursor: move;
        user-select: none;
    }

    .widget-body {
        flex: 1;
        overflow: auto;
        color: #9ca3af;
        font-size: 0.875rem;
        padding: 1.25rem;
    }

    .chart-container {
        width: 100%;
        height: 100%;
    }

    .chat-container {
        display: flex;
        flex-direction: column;
        height: 100%;
    }

    .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 0.5rem;
        font-size: 0.8rem;
    }

    .chat-message {
        margin-bottom: 0.5rem;
        padding: 0.5rem;
        background: rgba(128, 128, 128, 0.1);
        border-radius: 6px;
    }

    .chat-input-area {
        display: flex;
        gap: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .chat-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        padding: 0.5rem;
        color: #f9fafb;
        font-size: 0.8rem;
    }

    .chat-btn {
        background: rgba(128, 128, 128, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 4px;
        padding: 0.5rem 1rem;
        color: #f9fafb;
        cursor: pointer;
        font-size: 0.8rem;
    }

    .chat-btn:hover {
        background: rgba(128, 128, 128, 0.5);
    }

    @@media (max-width: 768px) {
        .dashboard-container {
            margin-left: 0;
            padding: 1rem;
        }
    }
</style>

<div class="dashboard-container">
    
    <div class="grid-stack">
        <!-- Market Data Widget -->
        <div class="grid-stack-item" gs-w="4" gs-h="4" gs-x="0" gs-y="0">
            <div class="grid-stack-item-content">
                <div class="widget-header">Market Overview</div>
                <div class="widget-body" style="padding: 0;">
                    <div id="marketDataChart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Technical Analysis Widget -->
        <div class="grid-stack-item" gs-w="4" gs-h="4" gs-x="4" gs-y="0">
            <div class="grid-stack-item-content">
                <div class="widget-header">Technical Chart</div>
                <div class="widget-body" style="padding: 0;">
                    <div id="technicalChart" class="chart-container"></div>
                </div>
            </div>
        </div>

        <!-- Market Sentiment Widget -->
        <div class="grid-stack-item" gs-w="2" gs-h="3" gs-x="8" gs-y="0">
            <div class="grid-stack-item-content">
                <div class="widget-header">Market Sentiment</div>
                <div class="widget-body">
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Overall Sentiment</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #10b981;">Bullish</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Fear & Greed</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">65</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">News Sentiment</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">+0.45</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Chat Widget -->
        <div class="grid-stack-item" gs-w="2" gs-h="5" gs-x="10" gs-y="0">
            <div class="grid-stack-item-content">
                <div class="widget-header">AI Assistant</div>
                <div class="widget-body" style="padding: 0;">
                    <div class="chat-container">
                        <div class="chat-messages" id="chatMessages">
                            <div class="chat-message">
                                <strong>AI:</strong> Hello! Ask me anything about your portfolio or market analysis.
                            </div>
                        </div>
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" placeholder="Ask a question..." id="chatInput" />
                            <button class="chat-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Portfolio Performance Widget -->
        <div class="grid-stack-item" gs-w="3" gs-h="3" gs-x="0" gs-y="4">
            <div class="grid-stack-item-content">
                <div class="widget-header">Portfolio Performance</div>
                <div class="widget-body">
                    <div style="display: flex; flex-direction: column; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Total Value</div>
                            <div style="font-size: 1.5rem; font-weight: 600;">$125,450.00</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Today's P/L</div>
                            <div style="font-size: 1.2rem; font-weight: 600; color: #10b981;">+$2,340.50 (+1.87%)</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.5rem;">Top Performers</div>
                            <div style="display: flex; gap: 1rem;">
                                <span>NVDA: <span style="color: #10b981;">+5.2%</span></span>
                                <span>AAPL: <span style="color: #10b981;">+2.1%</span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Risk Metrics Widget -->
        <div class="grid-stack-item" gs-w="3" gs-h="3" gs-x="3" gs-y="4">
            <div class="grid-stack-item-content">
                <div class="widget-header">Risk Analytics</div>
                <div class="widget-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Beta</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">1.15</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Sharpe</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">1.82</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Max DD</div>
                            <div style="font-size: 1.1rem; font-weight: 600; color: #ef4444;">-8.3%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">VaR (95%)</div>
                            <div style="font-size: 1.1rem; font-weight: 600;">-$3,200</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reddit Trending Widget -->
        <div class="grid-stack-item" gs-w="2" gs-h="3" gs-x="6" gs-y="4">
            <div class="grid-stack-item-content">
                <div class="widget-header">Reddit Trending</div>
                <div class="widget-body">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="padding: 0.75rem; background: rgba(128, 128, 128, 0.1); border-radius: 8px; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">TSLA</span>
                            <span style="opacity: 0.7;">2.3k</span>
                        </div>
                        <div style="padding: 0.75rem; background: rgba(128, 128, 128, 0.1); border-radius: 8px; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">NVDA</span>
                            <span style="opacity: 0.7;">1.8k</span>
                        </div>
                        <div style="padding: 0.75rem; background: rgba(128, 128, 128, 0.1); border-radius: 8px; display: flex; justify-content: space-between;">
                            <span style="font-weight: 600;">AAPL</span>
                            <span style="opacity: 0.7;">1.5k</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI Analysis Widget -->
        <div class="grid-stack-item" gs-w="2" gs-h="2" gs-x="8" gs-y="3">
            <div class="grid-stack-item-content">
                <div class="widget-header">AI Market Outlook</div>
                <div class="widget-body">
                    <div>
                        <div style="font-size: 0.75rem; opacity: 0.7; margin-bottom: 0.5rem;">Recommendation</div>
                        <div style="font-size: 1rem; font-weight: 600; color: #10b981; margin-bottom: 0.75rem;">BULLISH</div>
                        <div style="font-size: 0.8rem; line-height: 1.5;">
                            Strong momentum in tech. Volume increasing. Positive earnings sentiment.
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistical Patterns Widget -->
        <div class="grid-stack-item" gs-w="3" gs-h="2" gs-x="0" gs-y="7">
            <div class="grid-stack-item-content">
                <div class="widget-header">Statistical Patterns</div>
                <div class="widget-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Mean Reversion</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">AAPL Detected</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Momentum</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">Strong Tech</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Vol Clustering</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">Present</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Anomalies</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">None</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Economic Indicators Widget -->
        <div class="grid-stack-item" gs-w="3" gs-h="2" gs-x="3" gs-y="7">
            <div class="grid-stack-item-content">
                <div class="widget-header">Economic Indicators</div>
                <div class="widget-body">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">GDP Growth</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">2.8%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Unemployment</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">3.7%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">CPI</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">3.2%</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; opacity: 0.7;">Fed Rate</div>
                            <div style="font-size: 0.9rem; font-weight: 600;">5.25%</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Options Flow Widget -->
        <div class="grid-stack-item" gs-w="2" gs-h="2" gs-x="6" gs-y="7">
            <div class="grid-stack-item-content">
                <div class="widget-header">Options Flow</div>
                <div class="widget-body">
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 0.75rem; opacity: 0.7;">Unusual Activity</span>
                            <span style="font-weight: 600;">12</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 0.75rem; opacity: 0.7;">Call/Put Ratio</span>
                            <span style="font-weight: 600;">1.35</span>
                        </div>
                        <div style="display: flex; justify-content: space-between;">
                            <span style="font-size: 0.75rem; opacity: 0.7;">Max Pain</span>
                            <span style="font-weight: 600;">$185</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/gridstack@10.3.1/dist/gridstack-all.js"></script>

@code {
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await InitializeGridStack();
            await InitializeCharts();
        }
    }

    private async Task InitializeGridStack()
    {
        try
        {
            await JS.InvokeVoidAsync("eval", @"
                if (typeof GridStack !== 'undefined') {
                    const grid = GridStack.init({
                        column: 12,
                        cellHeight: 80,
                        margin: 12,
                        float: true,
                        animate: true,
                        resizable: {
                            handles: 'all'
                        },
                        draggable: {
                            handle: '.widget-header',
                            scroll: true
                        },
                        minRow: 10,
                        acceptWidgets: true,
                        disableOneColumnMode: true
                    });
                    console.log('GridStack initialized with', grid.getColumn(), 'columns');
                }
            ");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"GridStack initialization error: {ex.Message}");
        }
    }

    private async Task InitializeCharts()
    {
        try
        {
            // Market Data Chart
            await JS.InvokeVoidAsync("createTradingViewChart", "marketDataChart", "NASDAQ:AAPL", "60", 250);
            
            // Technical Analysis Chart
            await JS.InvokeVoidAsync("createTradingViewChart", "technicalChart", "NASDAQ:NVDA", "D", 250);
            
            Console.WriteLine("Dashboard charts initialized");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Dashboard initialization error: {ex.Message}");
        }
    }
}
