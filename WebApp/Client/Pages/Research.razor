@page "/research"
@using System.Text.RegularExpressions
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS
@inject HttpClient Http

<PageTitle>RAG Paper Chat - Deep Academic Analysis</PageTitle>

<style>
    .pdf-drop-zone {
        border: 2px dashed rgba(255, 255, 255, 0.2);
        background: rgba(255, 255, 255, 0.02);
    }

    .pdf-drop-zone:hover {
        border-color: rgba(16, 185, 129, 0.5);
        background: rgba(16, 185, 129, 0.05);
    }

    .pdf-drop-zone-active {
        border: 2px dashed #10b981 !important;
        background: rgba(16, 185, 129, 0.1) !important;
        transform: scale(0.98);
    }

    .research-container {
        position: fixed;
        left: 280px;
        top: 0;
        right: 0;
        bottom: 0;
        background: inherit;
        overflow-x: hidden;
        overflow-y: auto;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    .research-header {
        background: rgba(18, 18, 18, 0.95);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1rem 1.5rem;
        position: sticky;
        top: 0;
        z-index: 100;
        flex-shrink: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .tab-navigation {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 0.5rem 1rem;
        color: #9ca3af;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: #f9fafb;
        background: rgba(255, 255, 255, 0.05);
    }

    .tab-btn.active {
        color: #f9fafb;
        border-bottom-color: #888888;
    }

    .research-content {
        flex: 1;
        overflow-y: auto;
        padding: 1.5rem;
        width: 100%;
    }

    .feature-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
    }

    .feature-card {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1rem;
        transition: all 0.3s;
        min-width: 0;
        overflow: hidden;
    }

    .feature-card:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .feature-title {
        font-size: 0.95rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #ffffff;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        word-break: break-word;
    }

    .feature-description {
        font-size: 0.8rem;
        color: #9ca3af;
        line-height: 1.4;
        margin-bottom: 1rem;
        word-break: break-word;
    }

    .feature-status {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-bottom: 0.75rem;
    }

    .status-available {
        background: rgba(16, 185, 129, 0.2);
        color: #10b981;
        border: 1px solid rgba(16, 185, 129, 0.3);
    }

    .status-partial {
        background: rgba(251, 191, 36, 0.2);
        color: #fbbf24;
        border: 1px solid rgba(251, 191, 36, 0.3);
    }

    .status-coming-soon {
        background: rgba(107, 114, 128, 0.2);
        color: #9ca3af;
        border: 1px solid rgba(107, 114, 128, 0.3);
    }

    .feature-actions {
        display: flex;
        gap: 0.5rem;
        margin-top: 1rem;
    }

    .action-btn {
        flex: 1;
        padding: 0.5rem 1rem;
        background: rgba(26, 115, 232, 0.1);
        border: 1px solid rgba(26, 115, 232, 0.3);
        color: #1a73e8;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        font-size: 0.85rem;
        font-weight: 500;
    }

    .action-btn:hover {
        background: rgba(26, 115, 232, 0.2);
        border-color: rgba(26, 115, 232, 0.5);
    }

    .action-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .model-btn {
        padding: 0.6rem 1.5rem;
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        color: #9ca3af;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .model-btn:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        color: #f9fafb;
    }

    .model-btn.active {
        background: linear-gradient(135deg, #1a73e8 0%, #0d47a1 100%);
        border-color: #1a73e8;
        color: #ffffff;
        box-shadow: 0 4px 12px rgba(26, 115, 232, 0.3);
    }

    .section-header {
        font-size: 1.5rem;
        font-weight: 700;
        margin-bottom: 1.5rem;
        color: #ffffff;
    }

    .chat-interface {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        display: flex;
        gap: 1rem;
    }

    .chat-input {
        flex: 1;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        color: #ffffff;
        padding: 0.75rem 1rem;
        border-radius: 8px;
        font-size: 0.95rem;
    }

    .chat-input:focus {
        outline: none;
        border-color: #1a73e8;
        background: rgba(255, 255, 255, 0.07);
    }

    .chat-submit {
        padding: 0.75rem 2rem;
        background: #1a73e8;
        border: none;
        color: #ffffff;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.2s;
        font-weight: 600;
    }

    .chat-submit:hover {
        background: #1557b0;
    }

    .loading-indicator {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }

    .progress-container {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        gap: 1rem;
        padding: 3rem;
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        margin-bottom: 2rem;
    }

    .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.1);
        border-top: 4px solid #10b981;
        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .progress-text {
        color: #10b981;
        font-size: 0.95rem;
        font-weight: 500;
        animation: fadeInOut 2s ease-in-out infinite;
    }

    @@keyframes fadeInOut {
        0%, 100% { opacity: 0.5; }
        50% { opacity: 1; }
    }

    .no-results {
        text-align: center;
        padding: 2rem;
        color: #6b7280;
        font-style: italic;
    }
</style>

<div class="research-container">
    <div class="research-header">
        <div class="tab-navigation">
            <button class="tab-btn @(activeTab == "ai-assistant" ? "active" : "")" @onclick='() => SwitchTab("ai-assistant")'>AI Assistant</button>
            <button class="tab-btn @(activeTab == "rag-chat" ? "active" : "")" @onclick='() => SwitchTab("rag-chat")'>RAG Chat</button>
            <button class="tab-btn @(activeTab == "video-analysis" ? "active" : "")" @onclick='() => SwitchTab("video-analysis")'>Video Analysis</button>
            <button class="tab-btn @(activeTab == "academic-papers" ? "active" : "")" @onclick='() => SwitchTab("academic-papers")'>Papers</button>
            <button class="tab-btn @(activeTab == "scraper" ? "active" : "")" @onclick='() => SwitchTab("scraper")'>Scraper</button>
            <button class="tab-btn @(activeTab == "research-synthesis" ? "active" : "")" @onclick='() => SwitchTab("research-synthesis")'>Synthesis</button>
            <button class="tab-btn @(activeTab == "research-reports" ? "active" : "")" @onclick='() => SwitchTab("research-reports")'>Reports</button>
        </div>
    </div>

    <div class="research-content">
        @if (activeTab == "ai-assistant")
        {
            <div class="section-header">
                Feen - Your AI Research Assistant
            </div>

            <div class="model-selector" style="margin-bottom: 1rem; display: flex; gap: 1rem; align-items: center; padding: 1rem; background: rgba(255, 255, 255, 0.03); border-radius: 12px;">
                <label style="color: #9ca3af; font-weight: 600; font-size: 0.9rem;">AI Model:</label>
                <button class="model-btn @(selectedModel == "openai" ? "active" : "")" @onclick='() => selectedModel = "openai"'>
                    OpenAI GPT-4
                </button>
                <button class="model-btn @(selectedModel == "deepseek" ? "active" : "")" @onclick='() => selectedModel = "deepseek"'>
                    DeepSeek
                </button>
                <span style="color: #6b7280; font-size: 0.85rem; margin-left: auto;">
                    Feen can access all tools: market data, analysis, research papers, and more!
                </span>
            </div>

            <div class="chat-interface">
                <input type="text" class="chat-input" placeholder="Ask Feen anything! I can analyze markets, run statistical tests, search papers, forecast trends, and more..." @bind="chatQuery" @onkeypress="HandleChatKeyPress" />
                <button class="chat-submit" @onclick="SendChatQuery">Ask Feen</button>
            </div>

            @if (isLoading)
            {
                <div class="progress-container">
                    <div class="spinner"></div>
                    <div class="progress-text">Feen is analyzing your query and gathering insights...</div>
                </div>
            }
            else if (!string.IsNullOrEmpty(lastResult))
            {
                <AIOutputRenderer Content="@lastResult" />
            }

            <div class="feature-grid">
                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Chat Assistant
                    </div>
                    <div class="feature-description">
                        Interactive AI assistant for general research queries, market analysis, and strategic insights. Supports DeepSeek and OpenAI models.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="OpenChatAssistant">Open Chat</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Quick Research
                    </div>
                    <div class="feature-description">
                        Get instant answers to specific research questions with AI-powered quick research that synthesizes information from multiple sources.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="StartQuickResearch">Start Research</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research LLM
                    </div>
                    <div class="feature-description">
                        Advanced LLM-powered research engine for deep market analysis, strategy development, and quantitative insights.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="LaunchResearchLLM">Launch</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research Query Builder
                    </div>
                    <div class="feature-description">
                        Build complex research queries with natural language and get structured insights from academic papers, market data, and news.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="BuildResearchQuery">Build Query</button>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "video-analysis")
        {
            @if (!string.IsNullOrEmpty(videoError))
            {
                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ef4444; margin: 0;">Error: @videoError</p>
                </div>
            }

            <!-- Split View: Chat + Transcript -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: calc(100vh - 200px); min-height: 750px;">
                
                <!-- Left: Chat Interface with Controls -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    
                    <!-- Input Controls - Above chat -->
                    <div style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="margin-bottom: 0.75rem; color: #9ca3af; font-size: 0.85rem; font-weight: 500;">Load Content</div>
                        
                        <!-- YouTube URL 1 -->
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.5rem;">
                            <input type="text" @bind="videoUrl1" placeholder="YouTube URL 1 (required)" 
                                   style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;" />
                        </div>

                        <!-- YouTube URL 2 OR PDF Upload -->
                        <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 0.75rem;">
                            <input type="text" @bind="videoUrl2" placeholder="YouTube URL 2 OR..." 
                                   style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;" />
                            <InputFile OnChange="HandleVideoPdfUpload" accept=".pdf" style="display: none;" id="videoPdfUpload" />
                            <label for="videoPdfUpload" style="padding: 0.75rem 1rem; background: rgba(139, 92, 246, 0.1); border: 1px solid rgba(139, 92, 246, 0.3); border-radius: 8px; color: #a78bfa; cursor: pointer; font-size: 0.85rem; white-space: nowrap; transition: all 0.2s;">
                                @(string.IsNullOrEmpty(uploadedPdfName) ? "Upload PDF" : uploadedPdfName)
                            </label>
                        </div>

                        <button class="action-btn" @onclick="LoadVideoContent" disabled="@isLoadingVideo" style="width: 100%; padding: 0.75rem;">
                            @if (isLoadingVideo)
                            {
                                <span>Loading...</span>
                            }
                            else
                            {
                                <span>Load & Analyze</span>
                            }
                        </button>

                        @if (loadedVideos.Any())
                        {
                            <div style="margin-top: 0.75rem; display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                @foreach (var video in loadedVideos)
                                {
                                    <span style="padding: 0.4rem 0.75rem; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 6px; font-size: 0.8rem; color: #10b981;">
                                        @video.Title.Substring(0, Math.Min(30, video.Title.Length))@(video.Title.Length > 30 ? "..." : "")
                                    </span>
                                }
                                <button @onclick="ClearVideoContent" style="padding: 0.4rem 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; font-size: 0.8rem; color: #ef4444; cursor: pointer;">
                                    Clear All
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Chat Interface -->
                    <div style="flex: 1; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                            <div style="color: #f59e0b; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">AI Trading Analyst</div>
                            <div style="color: #9ca3af; font-size: 0.8rem;">Powered by DeepSeek + Semantic Kernel</div>
                        </div>
                        
                        <!-- Chat Messages -->
                        <div style="flex: 1; overflow-y: auto; padding: 1rem; background: rgba(0, 0, 0, 0.2);" id="videoChatContainer">
                            @if (videoMessages.Any())
                            {
                                @foreach (var msg in videoMessages)
                                {
                                    <div style="margin-bottom: 1rem; padding: 1rem; background: @(msg.IsUser ? "rgba(59, 130, 246, 0.1)" : "rgba(245, 158, 11, 0.1)"); border-radius: 8px; border-left: 3px solid @(msg.IsUser ? "#3b82f6" : "#f59e0b");">
                                        <div style="color: @(msg.IsUser ? "#3b82f6" : "#f59e0b"); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                            @(msg.IsUser ? "You" : "Trading Analyst")
                                        </div>
                                        @if (msg.IsUser)
                                        {
                                            <div style="color: #d1d5db; line-height: 1.6;">@msg.Content</div>
                                        }
                                        else
                                        {
                                            <AIOutputRenderer Content="@msg.Content" />
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center;">
                                    <div>
                                        <div>@(loadedVideos.Any() ? "Ask about trading signals, market insights, or video content" : "Load a video to start analyzing")</div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Chat Input -->
                        <div style="padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" @bind="videoQuestion" @bind:event="oninput" @onkeydown="HandleVideoChatKeyPress"
                                       placeholder="Ask about trading signals, market insights..." 
                                       disabled="@(!loadedVideos.Any() || isSendingVideoMessage)"
                                       style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;" />
                                <button class="action-btn" @onclick="SendVideoQuestion" disabled="@(!loadedVideos.Any() || isSendingVideoMessage || string.IsNullOrWhiteSpace(videoQuestion))" 
                                        style="padding: 0.75rem 1.25rem; white-space: nowrap;">
                                    @if (isSendingVideoMessage)
                                    {
                                        <span>Sending...</span>
                                    }
                                    else
                                    {
                                        <span>Send</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right: Transcript Viewer -->
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                        <div style="color: #10b981; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">Video Transcript</div>
                        <div style="color: #9ca3af; font-size: 0.8rem;">@(!string.IsNullOrEmpty(currentVideoTitle) ? currentVideoTitle : "No video loaded")</div>
                    </div>
                    <div style="flex: 1; overflow: auto; padding: 1.5rem; background: rgba(0, 0, 0, 0.2);">
                        @if (!string.IsNullOrEmpty(currentTranscript))
                        {
                            <div style="color: #d1d5db; line-height: 1.8; font-size: 0.95rem; white-space: pre-wrap; word-wrap: break-word;">
                                @currentTranscript
                            </div>
                        }
                        else
                        {
                            <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center;">
                                <div>
                                    <div>Load a video to view its transcript</div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "rag-chat")
        {
            @if (!string.IsNullOrEmpty(ragError))
            {
                <div style="padding: 0.75rem; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 8px; margin-bottom: 1rem;">
                    <p style="color: #ef4444; margin: 0;">Error: @ragError</p>
                </div>
            }

            <!-- Split View: PDF Viewer + Chat with Controls -->
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; height: calc(100vh - 200px); min-height: 750px;">
                
                <!-- Left: PDF Viewer -->
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                    <div style="padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                        <div style="color: #10b981; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">PDF Viewer</div>
                        <div style="color: #9ca3af; font-size: 0.8rem;">@(!string.IsNullOrEmpty(currentPaperTitle) ? currentPaperTitle : "No paper loaded")</div>
                    </div>
                    <div style="flex: 1; overflow: auto; background: #1a1a1a;">
                        @if (!string.IsNullOrEmpty(currentPdfUrl))
                        {
                            <iframe src="@GetPdfViewerUrl()" style="width: 100%; height: 100%; border: none;"></iframe>
                        }
                        else
                        {
                            <InputFile OnChange="HandlePdfUpload" accept=".pdf" style="display: none;" id="pdfUpload" />
                            <label for="pdfUpload"
                                 class="pdf-drop-zone"
                                 style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; cursor: pointer; transition: all 0.3s ease;">
                                <div style="text-align: center;">
                                    <div style="font-size: 1.1rem; margin-bottom: 0.5rem; font-weight: 500;">Click to Upload PDF</div>
                                    <div style="font-size: 0.85rem; color: #4b5563;">Supports PDF files up to 50MB</div>
                                </div>
                            </label>
                        }
                    </div>
                </div>

                <!-- Right: Controls + Chat Interface -->
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    
                    <!-- Paper Loading Controls - Above chat -->
                    <div style="padding: 1rem; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                            <input type="text" @bind="paperUrl" placeholder="Enter paper URL (e.g., https://arxiv.org/abs/2508.11152)" 
                                   style="flex: 1; min-width: 250px; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;" />
                            <button class="action-btn" @onclick="LoadPaper" disabled="@isLoadingPaper" style="padding: 0.75rem 1rem;">
                                @if (isLoadingPaper)
                                {
                                    <span>Loading...</span>
                                }
                                else
                                {
                                    <span>Load URL</span>
                                }
                            </button>
                            
                            @if (loadedPapers.Any())
                            {
                                <select @onchange="SelectLoadedPaper" style="min-width: 180px; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff; font-size: 0.9rem;">
                                    <option value="">Select a loaded paper...</option>
                                    @foreach (var paper in loadedPapers)
                                    {
                                        <option value="@paper.CollectionName">@paper.PaperTitle (@paper.ChunkCount chunks)</option>
                                    }
                                </select>
                            }
                            
                            @if (!string.IsNullOrEmpty(ragCollectionName))
                            {
                                <button class="action-btn danger" @onclick="ClearPapers" style="padding: 0.75rem 1rem; font-size: 0.9rem;">
                                    Clear All
                                </button>
                            }
                        </div>
                    </div>

                    <!-- Chat Interface -->
                    <div style="flex: 1; background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; overflow: hidden; display: flex; flex-direction: column;">
                        <div style="padding: 1rem; border-bottom: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                            <div style="color: #3b82f6; font-weight: 600; font-size: 0.9rem; margin-bottom: 0.25rem;">AI Chat Assistant</div>
                            <div style="color: #9ca3af; font-size: 0.8rem;">Powered by RAG + Qdrant</div>
                        </div>
                        
                        <!-- Chat Messages -->
                        <div style="flex: 1; overflow-y: auto; padding: 1rem; background: rgba(0, 0, 0, 0.2);">
                            @if (ragMessages.Any())
                            {
                                @foreach (var msg in ragMessages)
                                {
                                    <div style="margin-bottom: 1rem; padding: 1rem; background: @(msg.IsUser ? "rgba(59, 130, 246, 0.1)" : "rgba(16, 185, 129, 0.1)"); border-radius: 8px; border-left: 3px solid @(msg.IsUser ? "#3b82f6" : "#10b981");">
                                        <div style="color: @(msg.IsUser ? "#3b82f6" : "#10b981"); font-weight: 600; margin-bottom: 0.5rem; font-size: 0.85rem;">
                                            @(msg.IsUser ? "You" : "AI Assistant")
                                        </div>
                                        @if (msg.IsUser)
                                        {
                                            <div style="color: #d1d5db; line-height: 1.6;">@msg.Content</div>
                                        }
                                        else
                                        {
                                            <AIOutputRenderer Content="@msg.Content" />
                                        }
                                    </div>
                                }
                            }
                            else
                            {
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; text-align: center;">
                                    <div>
                                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">Tip</div>
                                        <div>@(string.IsNullOrEmpty(ragCollectionName) ? "Load a paper to start chatting" : "Ask a question about the paper")</div>
                                        <div style="font-size: 0.8rem; margin-top: 0.5rem; color: #4b5563;">
                                            @if (!string.IsNullOrEmpty(ragCollectionName))
                                            {
                                                <span>Try: "What is the main contribution?" or "Explain the methodology"</span>
                                            }
                                        </div>
                                    </div>
                                </div>
                            }
                        </div>

                        <!-- Chat Input -->
                        <div style="padding: 1rem; border-top: 1px solid rgba(255, 255, 255, 0.1); background: rgba(0, 0, 0, 0.3);">
                            <div style="display: flex; gap: 0.5rem;">
                                <input type="text" @bind="ragQuestion" @onkeypress="HandleChatKeyPress" placeholder="Ask a question about the paper..." 
                                       style="flex: 1; padding: 0.75rem; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 8px; color: #fff;" 
                                       disabled="@(string.IsNullOrEmpty(ragCollectionName))" />
                                <button class="action-btn" @onclick="AskQuestion" disabled="@(isAskingQuestion || string.IsNullOrEmpty(ragCollectionName))" style="min-width: 100px;">
                                    @if (isAskingQuestion)
                                    {
                                        <span>Thinking...</span>
                                    }
                                    else
                                    {
                                        <span>Send</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "academic-papers")
        {
            <div class="section-header">
                Academic Papers
            </div>

            <div class="chat-interface">
                <input type="text" class="chat-input" placeholder="Search for research papers (e.g., momentum investing, factor models, portfolio optimization)..." @bind="paperQuery" />
                <button class="chat-submit" @onclick="SearchPapers">Search Papers</button>
            </div>

            <div class="chat-interface" style="margin-top: 20px; border-top: 2px solid #2a2a2a; padding-top: 20px;">
                <div style="display: flex; gap: 10px; align-items: center;">
                    <InputFile OnChange="OnPdfSelected" accept=".pdf" id="pdfUpload" style="display: none;" />
                    <label for="pdfUpload" class="chat-submit" style="cursor: pointer; margin: 0;">
                        Select PDF
                    </label>
                    @if (!string.IsNullOrEmpty(selectedPdfName))
                    {
                        <span style="color: #4CAF50;">@selectedPdfName</span>
                        <button class="chat-submit" style="background: #FF9800;" @onclick="() => AnalyzePdf(false)" disabled="@isLoading">
                            Quick Insights
                        </button>
                        <button class="chat-submit" @onclick="() => AnalyzePdf(true)" disabled="@isLoading">
                            Full Analysis
                        </button>
                    }
                </div>
            </div>

            @if (isLoading)
            {
                <div class="progress-container">
                    <div class="spinner"></div>
                    <div class="progress-text">Searching academic papers...</div>
                </div>
            }
            else if (foundPapers.Any())
            {
                <div class="results-display">
                    <h3 style="color: #4CAF50; margin-bottom: 20px;">Found @foundPapers.Count Papers</h3>
                    @foreach (var paper in foundPapers)
                    {
                        <div style="background: #1a1a1a; padding: 15px; margin-bottom: 15px; border-radius: 8px; border-left: 3px solid #4CAF50;">
                            <h4 style="color: #4CAF50; margin: 0 0 10px 0;">@paper.Title</h4>
                            <p style="color: #888; font-size: 0.9em; margin: 5px 0;">@paper.Snippet</p>
                            <div style="margin-top: 10px; display: flex; gap: 10px; flex-wrap: wrap;">
                                <a href="@paper.Url" target="_blank" class="action-btn" style="font-size: 0.85em; padding: 8px 12px;">View</a>
                                <button class="action-btn" style="font-size: 0.85em; padding: 8px 12px; background: #FF9800;" 
                                        @onclick="() => GetQuickInsights(paper)" disabled="@isLoading">
                                    Quick Insights
                                </button>
                                <button class="action-btn" style="font-size: 0.85em; padding: 8px 12px; background: #2196F3;" 
                                        @onclick="() => DeepAnalyzePaper(paper)" disabled="@isLoading">
                                    Strategy Extract
                                </button>
                            </div>
                        </div>
                    }
                </div>
            }
            else if (!string.IsNullOrEmpty(lastResult))
            {
                <AIOutputRenderer Content="@lastResult" />
            }

            <div class="feature-grid">
                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Paper Search
                    </div>
                    <div class="feature-description">
                        Search academic papers from arXiv, SSRN, and Google Scholar. Find cutting-edge quantitative finance research.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="SearchAcademicPapers">Search Papers</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Paper Analysis
                    </div>
                    <div class="feature-description">
                        AI-powered analysis of research papers. Extract key findings, methodologies, and actionable trading strategies.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="AnalyzePaper">Analyze Paper</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research Synthesis
                    </div>
                    <div class="feature-description">
                        Synthesize findings from multiple papers. Create comprehensive literature reviews and research summaries.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="SynthesizePapers">Synthesize</button>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "scraper")
        {
            <div class="section-header">
                Research Scraper - Multiple Sources
            </div>

            <div style="margin-bottom: 2rem;">
                <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h6 style="color: #10b981; margin-bottom: 1rem; font-weight: 600;">Scrape Quant Research from Popular Sources</h6>
                    <p style="color: #9ca3af; font-size: 0.9rem; margin-bottom: 1rem;">Extract papers, reports, and insights from LinkedIn, Twitter/X, ResearchGate, SSRN, GitHub, and more.</p>
                </div>

                <div class="feature-grid">
                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            LinkedIn Scraper
                        </div>
                        <div class="feature-description">
                            Scrape posts from LinkedIn companies and profiles. Great for Quant Insider, AlpacaHQ, and finance professionals.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("linkedin"))">Configure</button>
                        </div>
                    </div>

                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            Twitter/X Scraper
                        </div>
                        <div class="feature-description">
                            Track quant finance hashtags and accounts. Monitor #QuantFinance, #AlgoTrading, and researcher posts.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("twitter"))">Configure</button>
                        </div>
                    </div>

                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            ResearchGate Scraper
                        </div>
                        <div class="feature-description">
                            Extract papers from ResearchGate profiles and topics. Access preprints and working papers.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("researchgate"))">Configure</button>
                        </div>
                    </div>

                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            SSRN Scraper
                        </div>
                        <div class="feature-description">
                            Scrape papers from Social Science Research Network. Monitor financial economics and quantitative research.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("ssrn"))">Configure</button>
                        </div>
                    </div>

                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            GitHub Scraper
                        </div>
                        <div class="feature-description">
                            Find research repos and trading strategies. Search topics like quantitative-finance, algorithmic-trading.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("github"))">Configure</button>
                        </div>
                    </div>

                    <div class="feature-card">
                        <span class="feature-status status-available">AVAILABLE</span>
                        <div class="feature-title">
                            Medium/Substack Scraper
                        </div>
                        <div class="feature-description">
                            Scrape articles from Medium publications and Substack newsletters focusing on quant finance.
                        </div>
                        <div class="feature-actions">
                            <button class="action-btn" @onclick="@(() => ShowScraperDetails("medium"))">Configure</button>
                        </div>
                    </div>
                </div>

                @if (!string.IsNullOrEmpty(activeScraperType))
                {
                    <div style="background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.15); border-radius: 12px; padding: 1.5rem; margin-top: 2rem;">
                        <h6 style="color: #ffffff; margin-bottom: 1rem; font-weight: 600;">@GetScraperTitle(activeScraperType)</h6>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="color: #9ca3af; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">@GetScraperUrlLabel(activeScraperType)</label>
                            <input type="text" class="chat-input" style="margin-bottom: 0.5rem;" @bind="scraperUrl" placeholder="@GetScraperPlaceholder(activeScraperType)" />
                        </div>

                        @if (activeScraperType == "twitter" || activeScraperType == "github")
                        {
                            <div style="margin-bottom: 1rem;">
                                <label style="color: #9ca3af; font-size: 0.9rem; display: block; margin-bottom: 0.5rem;">Additional Query/Keywords</label>
                                <input type="text" class="chat-input" style="margin-bottom: 0.5rem;" @bind="scraperQuery" placeholder="e.g., algorithmic trading, mean reversion" />
                            </div>
                        }

                        <div style="display: flex; gap: 0.5rem;">
                            <button class="chat-submit" @onclick="StartScraping" disabled="@isLoading">Start Scraping</button>
                            <button class="action-btn" style="background: transparent; border: 1px solid rgba(255, 255, 255, 0.2);" @onclick="() => activeScraperType = string.Empty">Cancel</button>
                        </div>
                    </div>
                }

                @if (isLoading)
                {
                    <div class="progress-container">
                        <div class="spinner"></div>
                        <div class="progress-text">Scraping @activeScraperType...</div>
                    </div>
                }
                else if (scrapedPosts != null && scrapedPosts.Any())
                {
                    <div style="margin-top: 2rem;">
                        <h6 style="color: #10b981; margin-bottom: 1rem;">Scraped Results (@scrapedPosts.Count posts)</h6>
                        @foreach (var post in scrapedPosts)
                        {
                            <div style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 1rem; margin-bottom: 1rem;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <h6 style="color: #ffffff; font-weight: 600; margin: 0;">@post.Author</h6>
                                    <small style="color: #6b7280;">@post.Timestamp</small>
                                </div>
                                <p style="color: #d1d5db; font-size: 0.9rem; margin-bottom: 0.75rem;">@post.Content</p>
                                @if (post.Papers != null && post.Papers.Any())
                                {
                                    <div style="background: rgba(16, 185, 129, 0.1); border-left: 3px solid #10b981; padding: 0.75rem; margin-top: 0.75rem;">
                                        <strong style="color: #10b981; font-size: 0.85rem;">Papers/Reports:</strong>
                                        <ul style="margin: 0.5rem 0 0 1.25rem; color: #d1d5db; font-size: 0.85rem;">
                                            @foreach (var paper in post.Papers)
                                            {
                                                <li style="margin-bottom: 0.25rem;">
                                                    <a href="@paper.Link" target="_blank" style="color: #60a5fa; text-decoration: none;">@paper.Title</a>
                                                    @if (!string.IsNullOrEmpty(paper.DownloadLink))
                                                    {
                                                        <a href="@paper.DownloadLink" target="_blank" style="color: #10b981; margin-left: 0.5rem; font-size: 0.8rem;">[Download]</a>
                                                    }
                                                </li>
                                            }
                                        </ul>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
                else if (!isLoading && lastResult != null)
                {
                    <AIOutputRenderer Content="@lastResult" />
                }
            </div>
        }

        @if (activeTab == "research-synthesis")
        {
            <div class="section-header">
                Research Synthesis & Analysis
            </div>

            <div class="chat-interface">
                <input type="text" class="chat-input" placeholder="Enter research topic or strategy (e.g., mean reversion strategies, machine learning in trading)..." @bind="synthesisQuery" />
                <button class="chat-submit" @onclick="SynthesizeResearch">Synthesize</button>
            </div>

            @if (isLoading)
            {
                <div class="progress-container">
                    <div class="spinner"></div>
                    <div class="progress-text">Synthesizing research...</div>
                </div>
            }
            else if (!string.IsNullOrEmpty(lastResult))
            {
                <AIOutputRenderer Content="@lastResult" />
            }

            <div class="feature-grid">
                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research Synthesis
                    </div>
                    <div class="feature-description">
                        Combine insights from multiple sources including papers, news, market data, and historical analysis to create comprehensive research.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="SynthesizeResearchFeature">Synthesize Research</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Quick Research
                    </div>
                    <div class="feature-description">
                        Get rapid research insights on specific topics, stocks, or strategies. Perfect for time-sensitive analysis.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="QuickResearchFeature">Quick Research</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research Query System
                    </div>
                    <div class="feature-description">
                        Advanced query system for targeted research. Build complex queries with filters, date ranges, and source preferences.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="BuildQuerySystem">Build Query</button>
                    </div>
                </div>
            </div>
        }

        @if (activeTab == "research-reports")
        {
            <div class="section-header">
                Research Reports & Documentation
            </div>

            <div class="chat-interface">
                <input type="text" class="chat-input" placeholder="Enter symbol or topic for research report (e.g., AAPL, tech sector outlook, Q1 2026)..." @bind="reportQuery" />
                <button class="chat-submit" @onclick="GenerateReport">Generate Report</button>
            </div>

            @if (isLoading)
            {
                <div class="progress-container">
                    <div class="spinner"></div>
                    <div class="progress-text">Generating report...</div>
                </div>
            }
            else if (!string.IsNullOrEmpty(lastResult))
            {
                <AIOutputRenderer Content="@lastResult" />
            }

            <div class="feature-grid">
                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Research Report Generator
                    </div>
                    <div class="feature-description">
                        Generate comprehensive research reports combining technical analysis, fundamentals, sentiment, and market trends.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="GenerateResearchReport">Generate Report</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Strategy Research Reports
                    </div>
                    <div class="feature-description">
                        Create detailed strategy research reports with backtests, performance metrics, and risk analysis.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="CreateStrategyReport">Create Strategy Report</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-available">AVAILABLE</span>
                    <div class="feature-title">
                        Report Library
                    </div>
                    <div class="feature-description">
                        Access your generated research reports. Export to PDF, share with team, or integrate with your workflow.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" @onclick="ViewReportLibrary">View Reports</button>
                    </div>
                </div>

                <div class="feature-card">
                    <span class="feature-status status-coming-soon">COMING SOON</span>
                    <div class="feature-title">
                        Automated Report Scheduling
                    </div>
                    <div class="feature-description">
                        Schedule automated research reports. Get daily, weekly, or monthly reports delivered to your inbox.
                    </div>
                    <div class="feature-actions">
                        <button class="action-btn" disabled>Coming Soon</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@code {
    private string activeTab = "ai-assistant";
    private string chatQuery = "";
    private string selectedModel = "openai"; // "openai" or "deepseek"
    private List<ConversationMessage> conversationHistory = new();
    private string videoQuery = "";
    private string paperQuery = "";
    private string synthesisQuery = "";
    private string reportQuery = "";
    private string activeScraperType = "";
    private string scraperUrl = "";
    private string scraperQuery = "";
    private bool isLoading = false;
    private string? lastResult = null;
    private IBrowserFile? selectedPdf;
    private string selectedPdfName = "";
    private List<PaperResult> foundPapers = new();
    private List<ScrapedPost> scrapedPosts = new();

    // RAG Chat fields
    private string paperUrl = "";
    private string ragCollectionName = "";
    private string ragQuestion = "";
    private string ragError = "";
    private bool isLoadingPaper = false;
    private bool isAskingQuestion = false;
    private bool isClearingPapers = false;
    private List<RagMessage> ragMessages = new();
    private List<LoadedPaperInfo> loadedPapers = new();
    private string currentPdfUrl = "";
    private string currentPaperTitle = "";

    // Video Analysis fields
    private string videoUrl1 = "";
    private string videoUrl2 = "";
    private string videoQuestion = "";
    private string videoError = "";
    private bool isLoadingVideo = false;
    private bool isSendingVideoMessage = false;
    private List<RagMessage> videoMessages = new();
    private List<LoadedVideoInfo> loadedVideos = new();
    private string currentTranscript = "";
    private string currentVideoTitle = "";
    private string uploadedPdfName = "";
    private IBrowserFile? uploadedVideoPdf;

    public class LoadedVideoInfo
    {
        public string VideoId { get; set; } = "";
        public string Title { get; set; } = "";
        public string Transcript { get; set; } = "";
        public string Url { get; set; } = "";
    }

    public class LoadedPaperInfo
    {
        public string CollectionName { get; set; } = "";
        public string PaperTitle { get; set; } = "";
        public string PaperUrl { get; set; } = "";
        public int ChunkCount { get; set; }
    }

    public class RagMessage
    {
        public string Content { get; set; } = "";
        public bool IsUser { get; set; }
    }

    public class PaperResult
    {
        public string Title { get; set; } = "";
        public string Url { get; set; } = "";
        public string Snippet { get; set; } = "";
    }

    public class ScrapedPost
    {
        public string Author { get; set; } = "";
        public string Content { get; set; } = "";
        public string Timestamp { get; set; } = "";
        public List<PaperInfo>? Papers { get; set; }
    }

    public class PaperInfo
    {
        public string Title { get; set; } = "";
        public string Link { get; set; } = "";
        public string DownloadLink { get; set; } = "";
    }

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        lastResult = null;
        scrapedPosts.Clear();
        activeScraperType = "";
        StateHasChanged();
    }

    private void ShowScraperDetails(string scraperType)
    {
        activeScraperType = scraperType;
        scraperUrl = GetDefaultUrl(scraperType);
        scraperQuery = "";
        scrapedPosts.Clear();
        lastResult = null;
        StateHasChanged();
    }

    private string GetDefaultUrl(string scraperType)
    {
        return scraperType switch
        {
            "linkedin" => "https://www.linkedin.com/company/quant-insider/posts/?feedView=all&viewAsMember=true",
            "twitter" => "https://twitter.com/search?q=%23QuantFinance",
            "researchgate" => "https://www.researchgate.net/topic/Quantitative-Finance",
            "ssrn" => "https://papers.ssrn.com/sol3/JELJOUR_Results.cfm?form_name=journalBrowse&journal_id=1079991",
            "github" => "https://github.com/topics/quantitative-finance",
            "medium" => "https://medium.com/tag/quantitative-finance",
            _ => ""
        };
    }

    private string GetScraperTitle(string scraperType)
    {
        return scraperType switch
        {
            "linkedin" => "LinkedIn Scraper Configuration",
            "twitter" => "Twitter/X Scraper Configuration",
            "researchgate" => "ResearchGate Scraper Configuration",
            "ssrn" => "SSRN Scraper Configuration",
            "github" => "GitHub Scraper Configuration",
            "medium" => "Medium/Substack Scraper Configuration",
            _ => "Scraper Configuration"
        };
    }

    private string GetScraperUrlLabel(string scraperType)
    {
        return scraperType switch
        {
            "linkedin" => "LinkedIn Profile/Company URL",
            "twitter" => "Twitter Search URL or Handle",
            "researchgate" => "ResearchGate Profile/Topic URL",
            "ssrn" => "SSRN Topic/Author URL",
            "github" => "GitHub Topic/User URL",
            "medium" => "Medium Tag/Publication URL",
            _ => "URL"
        };
    }

    private string GetScraperPlaceholder(string scraperType)
    {
        return scraperType switch
        {
            "linkedin" => "https://www.linkedin.com/company/quant-insider/posts/",
            "twitter" => "https://twitter.com/search?q=%23QuantFinance or @username",
            "researchgate" => "https://www.researchgate.net/profile/Researcher-Name",
            "ssrn" => "https://papers.ssrn.com/sol3/cf_dev/AbsByAuth.cfm?per_id=12345",
            "github" => "https://github.com/topics/quantitative-finance",
            "medium" => "https://medium.com/tag/algorithmic-trading",
            _ => "Enter URL"
        };
    }

    private async Task StartScraping()
    {
        if (string.IsNullOrWhiteSpace(scraperUrl)) return;

        try
        {
            isLoading = true;
            scrapedPosts.Clear();
            lastResult = null;
            StateHasChanged();

            // Use existing LinkedIn endpoint for LinkedIn, generic for others
            if (activeScraperType == "linkedin")
            {
                var response = await Http.PostAsJsonAsync("api/research/linkedin-scrape", new { Url = scraperUrl });
                response.EnsureSuccessStatusCode();
                
                var posts = await response.Content.ReadFromJsonAsync<List<ScrapedPost>>();
                if (posts != null && posts.Any())
                {
                    scrapedPosts = posts;
                }
                else
                {
                    lastResult = "No posts found or scraping failed. LinkedIn may require authentication.";
                }
            }
            else
            {
                // For other scrapers, use a generic research endpoint or show placeholder message
                lastResult = $"Scraping {activeScraperType} is configured. Implementation note:\n\n";
                lastResult += $"URL: {scraperUrl}\n";
                lastResult += $"Query: {scraperQuery}\n\n";
                lastResult += $"To fully implement {activeScraperType} scraping:\n";
                lastResult += $"1. Add a scraping service for {activeScraperType}\n";
                lastResult += $"2. Create API endpoint in ApiController.cs\n";
                lastResult += $"3. Handle authentication if required\n\n";
                lastResult += "LinkedIn scraper is fully functional. Other scrapers show this placeholder.";
            }

            await JS.InvokeVoidAsync("console.log", $"Scraping {activeScraperType} complete");
        }
        catch (Exception ex)
        {
            lastResult = $"Error scraping {activeScraperType}: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleChatKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendChatQuery();
        }
    }

    private async Task SendChatQuery()
    {
        if (string.IsNullOrWhiteSpace(chatQuery)) return;
        
        try
        {
            isLoading = true;
            var userMessage = chatQuery;
            chatQuery = ""; // Clear immediately for better UX
            StateHasChanged();

            // Add user message to history
            conversationHistory.Add(new ConversationMessage
            {
                Role = "user",
                Content = userMessage,
                Timestamp = DateTime.UtcNow
            });

            // Call the new Feen RAGentic endpoint
            var response = await Http.PostAsJsonAsync("api/research/feen-chat", new 
            { 
                Message = userMessage,
                ModelProvider = selectedModel,
                ConversationHistory = conversationHistory
            });
            
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<FeenChatResponse>();
            
            if (result != null)
            {
                lastResult = result.Message;
                
                // Add assistant response to history
                conversationHistory.Add(new ConversationMessage
                {
                    Role = "assistant",
                    Content = result.Message,
                    Timestamp = result.Timestamp
                });

                // Keep only last 10 messages to avoid token limits
                if (conversationHistory.Count > 10)
                {
                    conversationHistory = conversationHistory.Skip(conversationHistory.Count - 10).ToList();
                }
            }
            
            await JS.InvokeVoidAsync("console.log", $"Feen Response received with {result?.ToolsUsed?.Count ?? 0} tools used");
        }
        catch (Exception ex)
        {
            lastResult = $"I apologize, but I encountered an error: {ex.Message}. Please try again.";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AnalyzeVideo()
    {
        if (string.IsNullOrWhiteSpace(videoQuery)) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/analyze-video", new { VideoUrl = videoQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Video Analysis Result: {lastResult}");
            videoQuery = "";
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SearchPapers()
    {
        if (string.IsNullOrWhiteSpace(paperQuery)) return;
        
        try
        {
            isLoading = true;
            foundPapers.Clear();
            lastResult = "";
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-papers", new { Query = paperQuery, MaxResults = 20 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            
            // Parse the result to extract individual papers
            if (!string.IsNullOrWhiteSpace(result?.Result))
            {
                ParsePapersFromResult(result.Result);
            }
            
            if (!foundPapers.Any())
            {
                lastResult = result?.Result ?? "No papers found";
            }
            
            await JS.InvokeVoidAsync("console.log", $"Found {foundPapers.Count} papers");
            paperQuery = "";
        }
        catch (Exception ex)
        {
            lastResult = $"Error: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void ParsePapersFromResult(string result)
    {
        var lines = result.Split('\n');
        PaperResult? currentPaper = null;
        
        foreach (var line in lines)
        {
            var trimmed = line.Trim();
            
            // Look for numbered papers like "1. Paper Title"
            if (Regex.IsMatch(trimmed, @"^\d+\.\s+"))
            {
                if (currentPaper != null)
                {
                    foundPapers.Add(currentPaper);
                }
                
                currentPaper = new PaperResult
                {
                    Title = Regex.Replace(trimmed, @"^\d+\.\s+", "")
                };
            }
            else if (currentPaper != null && trimmed.StartsWith("URL:"))
            {
                currentPaper.Url = trimmed.Replace("URL:", "").Trim();
            }
            else if (currentPaper != null && trimmed.StartsWith("Abstract/Summary:"))
            {
                currentPaper.Snippet = trimmed.Replace("Abstract/Summary:", "").Trim();
            }
        }
        
        if (currentPaper != null)
        {
            foundPapers.Add(currentPaper);
        }
    }

    private async Task GetQuickInsights(PaperResult paper)
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/quick-insights", new 
            { 
                Url = paper.Url,
                Title = paper.Title
            });
            
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result ?? "No insights generated";
            foundPapers.Clear(); // Clear to show insights
            
            await JS.InvokeVoidAsync("console.log", "Quick insights complete");
        }
        catch (Exception ex)
        {
            lastResult = $"Error getting insights: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task DeepAnalyzePaper(PaperResult paper)
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/deep-analyze-paper", new 
            { 
                Url = paper.Url,
                Title = paper.Title,
                StrategyName = paper.Title
            });
            
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result ?? "No analysis generated";
            foundPapers.Clear(); // Clear to show analysis result
            
            await JS.InvokeVoidAsync("console.log", "Deep analysis complete");
        }
        catch (Exception ex)
        {
            lastResult = $"Error in deep analysis: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private void OnPdfSelected(InputFileChangeEventArgs e)
    {
        selectedPdf = e.File;
        selectedPdfName = e.File.Name;
        StateHasChanged();
    }

    private async Task AnalyzePdf(bool fullAnalysis = true)
    {
        if (selectedPdf == null) return;

        try
        {
            isLoading = true;
            lastResult = "";
            StateHasChanged();

            // Read PDF file (max 10MB)
            var buffer = new byte[selectedPdf.Size];
            await selectedPdf.OpenReadStream(maxAllowedSize: 10 * 1024 * 1024).ReadAsync(buffer);

            // Create multipart form content
            using var content = new MultipartFormDataContent();
            var fileContent = new ByteArrayContent(buffer);
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");
            content.Add(fileContent, "file", selectedPdf.Name);
            content.Add(new StringContent(fullAnalysis.ToString()), "fullAnalysis");

            var endpoint = fullAnalysis ? "api/research/analyze-pdf" : "api/research/analyze-pdf-quick";
            var response = await Http.PostAsync(endpoint, content);
            response.EnsureSuccessStatusCode();

            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result ?? "No analysis generated";
            
            await JS.InvokeVoidAsync("console.log", $"PDF Analysis Result: {lastResult}");
        }
        catch (Exception ex)
        {
            lastResult = $"Error analyzing PDF: {ex.Message}";
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SynthesizeResearch()
    {
        if (string.IsNullOrWhiteSpace(synthesisQuery)) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-synthesis", new { Topic = synthesisQuery, PaperUrls = new List<string>(), MaxPapers = 10 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Research Synthesis Result: {lastResult}");
            synthesisQuery = "";
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task GenerateReport()
    {
        if (string.IsNullOrWhiteSpace(reportQuery)) return;
        
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-report", new { Symbol = reportQuery, ReportType = "comprehensive" });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Report Result: {lastResult}");
            reportQuery = "";
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // AI Assistant tab methods
    private async Task OpenChatAssistant()
    {
        await JS.InvokeVoidAsync("console.log", "Opening Chat Assistant...");
        // Focus on chat input
        await JS.InvokeVoidAsync("eval", "document.querySelector('.chat-input')?.focus()");
    }

    private async Task StartQuickResearch()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/quick-research", new { Query = chatQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Quick Research: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task LaunchResearchLLM()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-llm", new { Query = chatQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Research LLM: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task BuildResearchQuery()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-query", new { Query = chatQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Research Query: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Video Analysis tab methods
    private async Task LoadVideoContent()
    {
        if (string.IsNullOrWhiteSpace(videoUrl1)) 
        {
            videoError = "Please enter at least one YouTube URL";
            return;
        }

        isLoadingVideo = true;
        videoError = "";
        videoMessages.Clear();
        StateHasChanged();

        try
        {
            // Load first video (required)
            var response1 = await Http.PostAsJsonAsync("api/research/load-video-transcript", new { VideoUrl = videoUrl1 });
            if (response1.IsSuccessStatusCode)
            {
                var result1 = await response1.Content.ReadFromJsonAsync<VideoTranscriptResponse>();
                if (result1 != null && !string.IsNullOrEmpty(result1.Transcript))
                {
                    loadedVideos.Add(new LoadedVideoInfo
                    {
                        VideoId = result1.VideoId,
                        Title = result1.Title,
                        Transcript = result1.Transcript,
                        Url = videoUrl1
                    });

                    // Display the first video's transcript
                    currentTranscript = result1.Transcript;
                    currentVideoTitle = result1.Title;

                    // Generate initial analysis
                    var analysisResponse = await Http.PostAsJsonAsync("api/research/analyze-video-content", new 
                    { 
                        Videos = loadedVideos.Select(v => new { v.VideoId, v.Title, v.Transcript }).ToList() 
                    });
                    
                    if (analysisResponse.IsSuccessStatusCode)
                    {
                        var analysis = await analysisResponse.Content.ReadFromJsonAsync<VideoAnalysisResponse>();
                        if (analysis != null && !string.IsNullOrEmpty(analysis.Analysis))
                        {
                            videoMessages.Add(new RagMessage
                            {
                                Content = analysis.Analysis,
                                IsUser = false
                            });
                        }
                    }
                }
            }

            // Load second video or PDF if provided
            if (!string.IsNullOrWhiteSpace(videoUrl2))
            {
                var response2 = await Http.PostAsJsonAsync("api/research/load-video-transcript", new { VideoUrl = videoUrl2 });
                if (response2.IsSuccessStatusCode)
                {
                    var result2 = await response2.Content.ReadFromJsonAsync<VideoTranscriptResponse>();
                    if (result2 != null && !string.IsNullOrEmpty(result2.Transcript))
                    {
                        loadedVideos.Add(new LoadedVideoInfo
                        {
                            VideoId = result2.VideoId,
                            Title = result2.Title,
                            Transcript = result2.Transcript,
                            Url = videoUrl2
                        });
                    }
                }
            }
            else if (uploadedVideoPdf != null)
            {
                // Handle PDF upload
                var content = new MultipartFormDataContent();
                var fileContent = new StreamContent(uploadedVideoPdf.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024));
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");
                content.Add(fileContent, "file", uploadedVideoPdf.Name);

                var pdfResponse = await Http.PostAsync("/api/research/upload-video-pdf", content);
                if (pdfResponse.IsSuccessStatusCode)
                {
                    var pdfResult = await pdfResponse.Content.ReadFromJsonAsync<PdfContentResponse>();
                    if (pdfResult != null && !string.IsNullOrEmpty(pdfResult.Content))
                    {
                        loadedVideos.Add(new LoadedVideoInfo
                        {
                            VideoId = "pdf_" + Guid.NewGuid().ToString("N"),
                            Title = uploadedVideoPdf.Name,
                            Transcript = pdfResult.Content,
                            Url = ""
                        });
                    }
                }
            }

            // Scroll to chat
            await JS.InvokeVoidAsync("scrollToBottom", "videoChatContainer");
        }
        catch (Exception ex)
        {
            videoError = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingVideo = false;
            StateHasChanged();
        }
    }

    private async Task HandleVideoPdfUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null || !file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            videoError = "Please upload a PDF file";
            return;
        }

        uploadedVideoPdf = file;
        uploadedPdfName = file.Name;
        videoUrl2 = ""; // Clear URL 2 if PDF is uploaded
        StateHasChanged();
    }

    private async Task SendVideoQuestion()
    {
        if (string.IsNullOrWhiteSpace(videoQuestion) || !loadedVideos.Any()) return;

        isSendingVideoMessage = true;
        videoError = "";
        
        // Add user message
        videoMessages.Add(new RagMessage
        {
            Content = videoQuestion,
            IsUser = true
        });

        var currentQuestion = videoQuestion;
        videoQuestion = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("api/research/video-chat", new
            {
                Question = currentQuestion,
                Videos = loadedVideos.Select(v => new { v.VideoId, v.Title, v.Transcript }).ToList(),
                ConversationHistory = videoMessages.Where(m => m.IsUser).Take(5).Select(m => m.Content).ToList()
            });

            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<VideoChatResponse>();
                if (result != null && !string.IsNullOrEmpty(result.Answer))
                {
                    videoMessages.Add(new RagMessage
                    {
                        Content = result.Answer,
                        IsUser = false
                    });

                    // Scroll to bottom
                    await JS.InvokeVoidAsync("scrollToBottom", "videoChatContainer");
                }
            }
            else
            {
                videoError = $"Error: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            videoError = $"Error: {ex.Message}";
        }
        finally
        {
            isSendingVideoMessage = false;
            StateHasChanged();
        }
    }

    private async Task HandleVideoChatKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(videoQuestion) && loadedVideos.Any() && !isSendingVideoMessage)
        {
            await SendVideoQuestion();
        }
    }

    private void ClearVideoContent()
    {
        loadedVideos.Clear();
        videoMessages.Clear();
        currentTranscript = "";
        currentVideoTitle = "";
        videoUrl1 = "";
        videoUrl2 = "";
        uploadedVideoPdf = null;
        uploadedPdfName = "";
        videoError = "";
        StateHasChanged();
    }

    private async Task AnalyzeVideoFeature()
    {
        if (string.IsNullOrWhiteSpace(videoQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/analyze-video", new { VideoUrl = videoQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Video Analysis: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task BrowseQuantopianLibrary()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.GetAsync("api/research/quantopian-videos");
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Quantopian Videos: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SearchFinanceVideos()
    {
        if (string.IsNullOrWhiteSpace(videoQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/search-finance-videos", new { Query = videoQuery, MaxResults = 10 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Finance Videos: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Academic Papers tab methods
    private async Task SearchAcademicPapers()
    {
        if (string.IsNullOrWhiteSpace(paperQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-papers", new { Query = paperQuery, MaxResults = 20 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Paper Search: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task AnalyzePaper()
    {
        if (string.IsNullOrWhiteSpace(paperQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/analyze-paper", new { PaperUrl = paperQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Paper Analysis: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task SynthesizePapers()
    {
        if (string.IsNullOrWhiteSpace(paperQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-synthesis", new { Topic = paperQuery, PaperUrls = new List<string>(), MaxPapers = 10 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Paper Synthesis: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Research Synthesis tab methods
    private async Task SynthesizeResearchFeature()
    {
        if (string.IsNullOrWhiteSpace(synthesisQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-synthesis", new { Topic = synthesisQuery, PaperUrls = new List<string>(), MaxPapers = 10 });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Research Synthesis: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task QuickResearchFeature()
    {
        if (string.IsNullOrWhiteSpace(synthesisQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/quick-research", new { Query = synthesisQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Quick Research: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task BuildQuerySystem()
    {
        if (string.IsNullOrWhiteSpace(synthesisQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-query", new { Query = synthesisQuery });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Query System: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    // Research Reports tab methods
    private async Task GenerateResearchReport()
    {
        if (string.IsNullOrWhiteSpace(reportQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-report", new { Symbol = reportQuery, ReportType = "comprehensive" });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Research Report: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task CreateStrategyReport()
    {
        if (string.IsNullOrWhiteSpace(reportQuery)) return;

        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.PostAsJsonAsync("api/research/research-report", new { Symbol = reportQuery, ReportType = "strategy" });
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadFromJsonAsync<ResearchResponse>();
            lastResult = result?.Result;
            
            await JS.InvokeVoidAsync("console.log", $"Strategy Report: {lastResult}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ViewReportLibrary()
    {
        try
        {
            isLoading = true;
            StateHasChanged();

            var response = await Http.GetAsync("api/research/report-library");
            response.EnsureSuccessStatusCode();
            
            var result = await response.Content.ReadAsStringAsync();
            lastResult = result;
            
            await JS.InvokeVoidAsync("console.log", $"Report Library: {result}");
        }
        catch (Exception ex)
        {
            await JS.InvokeVoidAsync("console.error", $"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    public class ResearchResponse
    {
        public string Result { get; set; } = string.Empty;
        public DateTime Timestamp { get; set; }
        public string Type { get; set; } = string.Empty;
    }

    public class FeenChatResponse
    {
        public required string Message { get; set; }
        public List<ToolUsage> ToolsUsed { get; set; } = new();
        public required string ModelProvider { get; set; }
        public DateTime Timestamp { get; set; }
        public List<ConversationMessage> ConversationHistory { get; set; } = new();
    }

    public class ToolUsage
    {
        public required string ToolName { get; set; }
        public Dictionary<string, string> Parameters { get; set; } = new();
        public required string Reason { get; set; }
        public bool Success { get; set; }
        public double ExecutionTime { get; set; }
        public required string ResultSummary { get; set; }
    }

    public class ConversationMessage
    {
        public required string Role { get; set; }
        public required string Content { get; set; }
        public DateTime Timestamp { get; set; }
    }

    // RAG Chat methods
    private async Task LoadPaper()
    {
        if (string.IsNullOrWhiteSpace(paperUrl))
        {
            ragError = "Please enter a paper URL";
            return;
        }

        isLoadingPaper = true;
        ragError = "";
        ragMessages.Clear();
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("/api/research/load-paper", new { url = paperUrl });
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoadPaperResponse>();
                if (result != null && !string.IsNullOrEmpty(result.CollectionName))
                {
                    ragCollectionName = result.CollectionName;
                    currentPdfUrl = paperUrl;
                    currentPaperTitle = result.Title ?? "Academic Paper";
                    
                    // Add to loaded papers list
                    loadedPapers.Add(new LoadedPaperInfo
                    {
                        CollectionName = result.CollectionName,
                        PaperTitle = currentPaperTitle,
                        PaperUrl = paperUrl,
                        ChunkCount = result.ChunkCount
                    });
                }
                else
                {
                    ragError = "Failed to load paper";
                }
            }
            else
            {
                ragError = $"Error: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            ragError = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingPaper = false;
            StateHasChanged();
        }
    }

    private async Task HandlePdfUpload(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file == null || !file.Name.EndsWith(".pdf", StringComparison.OrdinalIgnoreCase))
        {
            ragError = "Please upload a PDF file";
            return;
        }

        isLoadingPaper = true;
        ragError = "";
        ragMessages.Clear();
        StateHasChanged();

        try
        {
            // Upload PDF to server
            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 50 * 1024 * 1024)); // 50MB max
            fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/pdf");
            content.Add(fileContent, "file", file.Name);

            var response = await Http.PostAsync("/api/research/upload-paper", content);
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoadPaperResponse>();
                if (result != null && !string.IsNullOrEmpty(result.CollectionName))
                {
                    ragCollectionName = result.CollectionName;
                    currentPdfUrl = result.PdfUrl ?? "";
                    currentPaperTitle = result.Title ?? file.Name;
                    
                    loadedPapers.Add(new LoadedPaperInfo
                    {
                        CollectionName = result.CollectionName,
                        PaperTitle = currentPaperTitle,
                        PaperUrl = currentPdfUrl,
                        ChunkCount = result.ChunkCount
                    });
                }
                else
                {
                    ragError = "Failed to load paper";
                }
            }
            else
            {
                ragError = $"Error uploading file: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            ragError = $"Error: {ex.Message}";
        }
        finally
        {
            isLoadingPaper = false;
            StateHasChanged();
        }
    }

    private void SelectLoadedPaper(ChangeEventArgs e)
    {
        var collectionName = e.Value?.ToString();
        if (string.IsNullOrEmpty(collectionName)) return;

        var paper = loadedPapers.FirstOrDefault(p => p.CollectionName == collectionName);
        if (paper != null)
        {
            ragCollectionName = paper.CollectionName;
            currentPdfUrl = paper.PaperUrl;
            currentPaperTitle = paper.PaperTitle;
            ragMessages.Clear();
            StateHasChanged();
        }
    }

    private string GetPdfViewerUrl()
    {
        if (string.IsNullOrEmpty(currentPdfUrl))
            return "";
        
        // For URLs, embed directly
        if (currentPdfUrl.StartsWith("http"))
        {
            return currentPdfUrl;
        }
        
        // For uploaded files, use the server path
        return currentPdfUrl;
    }

    private async Task AskQuestion()
    {
        if (string.IsNullOrWhiteSpace(ragQuestion) || string.IsNullOrEmpty(ragCollectionName))
        {
            return;
        }

        isAskingQuestion = true;
        ragMessages.Add(new RagMessage { Content = ragQuestion, IsUser = true });
        var question = ragQuestion;
        ragQuestion = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsJsonAsync("/api/research/ask-question", new 
            { 
                collectionName = ragCollectionName,
                question = question 
            });
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<AskQuestionResponse>();
                if (result != null)
                {
                    ragMessages.Add(new RagMessage { Content = result.Answer, IsUser = false });
                }
            }
            else
            {
                ragMessages.Add(new RagMessage { Content = $"Error: {response.StatusCode}", IsUser = false });
            }
        }
        catch (Exception ex)
        {
            ragMessages.Add(new RagMessage { Content = $"Error: {ex.Message}", IsUser = false });
        }
        finally
        {
            isAskingQuestion = false;
            StateHasChanged();
        }
    }

    private async Task ClearPapers()
    {
        if (!await JS.InvokeAsync<bool>("confirm", new object[] { "This will permanently delete all loaded papers from the database. Are you sure?" }))
        {
            return;
        }

        isClearingPapers = true;
        ragError = "";
        StateHasChanged();

        try
        {
            var response = await Http.PostAsync("/api/research/clear-papers", null);
            
            if (response.IsSuccessStatusCode)
            {
                ragCollectionName = "";
                ragMessages.Clear();
                paperUrl = "";
                ragQuestion = "";
                ragError = "";
                
                // Show success message
                await JS.InvokeAsync<object>("alert", new object[] { "All papers have been cleared successfully!" });
            }
            else
            {
                ragError = $"Error clearing papers: {response.StatusCode}";
            }
        }
        catch (Exception ex)
        {
            ragError = $"Error: {ex.Message}";
        }
        finally
        {
            isClearingPapers = false;
            StateHasChanged();
        }
    }

    private async Task HandleRagKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !isAskingQuestion)
        {
            await AskQuestion();
        }
    }

    public class LoadPaperResponse
    {
        public string CollectionName { get; set; } = "";
        public string? Title { get; set; }
        public string? PdfUrl { get; set; }
        public int ChunkCount { get; set; }
    }

    public class AskQuestionResponse
    {
        public string Answer { get; set; } = "";
    }

    public class VideoTranscriptResponse
    {
        public string VideoId { get; set; } = "";
        public string Title { get; set; } = "";
        public string Transcript { get; set; } = "";
        public int TranscriptLength { get; set; }
    }

    public class VideoAnalysisResponse
    {
        public string Analysis { get; set; } = "";
        public List<string>? TradingSignals { get; set; }
    }

    public class VideoChatResponse
    {
        public string Answer { get; set; } = "";
    }

    public class PdfContentResponse
    {
        public string Content { get; set; } = "";
        public string FileName { get; set; } = "";
    }

}
