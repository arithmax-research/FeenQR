@page "/fundamental-analysis"
@using System.Text.Json
@inject HttpClient Http

<PageTitle>FeenQR - Fundamental Analysis</PageTitle>

<style>
    .fa-container {
        position: fixed;
        left: 280px;
        top: 0;
        right: 0;
        bottom: 0;
        background: inherit;
        overflow-x: hidden;
        overflow-y: auto;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
    }

    .fa-header {
        background: rgba(18, 18, 18, 0.95);
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1rem 1.5rem;
        position: sticky;
        top: 0;
        z-index: 100;
        flex-shrink: 0;
        width: 100%;
        box-sizing: border-box;
    }

    .tab-navigation {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
    }

    .tab-btn {
        background: transparent;
        border: none;
        padding: 0.5rem 1rem;
        color: #9ca3af;
        font-size: 0.875rem;
        font-weight: 600;
        cursor: pointer;
        border-bottom: 2px solid transparent;
        transition: all 0.2s;
    }

    .tab-btn:hover {
        color: #1a73e8;
        border-bottom-color: rgba(26, 115, 232, 0.3);
    }

    .tab-btn.active {
        color: #1a73e8;
        border-bottom-color: #1a73e8;
    }

    .fa-content {
        flex: 1;
        padding: 2rem;
        overflow-y: auto;
    }

    .input-section {
        background: rgba(255, 255, 255, 0.02);
        padding: 1.5rem;
        border-radius: 8px;
        margin-bottom: 2rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
    }

    .input-group {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        flex-wrap: wrap;
    }

    .input-field {
        flex: 1;
        min-width: 200px;
    }

    .input-field label {
        display: block;
        color: #9ca3af;
        font-size: 0.875rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .input-field input,
    .input-field select {
        width: 100%;
        padding: 0.75rem;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 6px;
        color: #fff;
        font-size: 0.875rem;
    }

    .btn-primary {
        background: #1a73e8;
        color: white;
        border: none;
        padding: 0.75rem 1.5rem;
        border-radius: 6px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .btn-primary:hover {
        background: #1557b0;
    }

    .btn-primary:disabled {
        background: #555;
        cursor: not-allowed;
    }

    .loading {
        text-align: center;
        padding: 2rem;
        color: #9ca3af;
    }

    .results-card {
        background: rgba(255, 255, 255, 0.02);
        border-radius: 8px;
        padding: 1.5rem;
        border: 1px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 1rem;
    }

    .results-card h3 {
        color: #fff;
        font-size: 1.125rem;
        margin: 0 0 1rem 0;
        padding-bottom: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        margin-top: 1rem;
    }

    .metric-item {
        background: rgba(255, 255, 255, 0.03);
        padding: 1rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .metric-label {
        color: #9ca3af;
        font-size: 0.813rem;
        margin-bottom: 0.5rem;
        font-weight: 500;
    }

    .metric-value {
        color: #fff;
        font-size: 1.125rem;
        font-weight: 600;
    }

    .metric-value.positive {
        color: #10b981;
    }

    .metric-value.neutral {
        color: #f59e0b;
    }

    .metric-value.negative {
        color: #ef4444;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        padding: 0.75rem 0;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .info-row:last-child {
        border-bottom: none;
    }

    .info-label {
        color: #9ca3af;
        font-size: 0.875rem;
    }

    .info-value {
        color: #fff;
        font-size: 0.875rem;
        font-weight: 500;
    }

    .comparison-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1rem;
    }

    .comparison-table th,
    .comparison-table td {
        padding: 0.75rem;
        text-align: left;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .comparison-table th {
        color: #9ca3af;
        font-size: 0.813rem;
        font-weight: 600;
        text-transform: uppercase;
    }

    .comparison-table td {
        color: #fff;
        font-size: 0.875rem;
    }

    .symbol-chip {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(26, 115, 232, 0.2);
        border: 1px solid rgba(26, 115, 232, 0.3);
        color: #1a73e8;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        margin: 0.25rem;
        font-weight: 500;
    }

    .remove-chip {
        background: none;
        border: none;
        color: #1a73e8;
        cursor: pointer;
        font-size: 1.1rem;
        padding: 0;
        line-height: 1;
    }

    .symbol-chips-container {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .description-text {
        color: #d1d5db;
        font-size: 0.938rem;
        line-height: 1.6;
        margin-top: 1rem;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.02);
        border-radius: 6px;
    }

    .table-container {
        overflow-x: auto;
        margin-top: 1rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.02);
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .financial-table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.875rem;
    }

    .financial-table th {
        background: rgba(26, 115, 232, 0.1);
        color: #9ca3af;
        padding: 0.75rem;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.75rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .financial-table td {
        padding: 0.75rem;
        color: #fff;
        border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }

    .financial-table tr:hover {
        background: rgba(255, 255, 255, 0.02);
    }

    .financial-table td:nth-child(3),
    .financial-table td:nth-child(4),
    .financial-table td:nth-child(5),
    .financial-table td:nth-child(6),
    .financial-table td:nth-child(7) {
        text-align: right;
        font-family: 'Courier New', monospace;
    }
</style>

<div class="fa-container">
    <div class="fa-header">
        <div class="tab-navigation">
            <button class="tab-btn @(activeTab == "overview" ? "active" : "")" @onclick='() => SwitchTab("overview")'>Overview</button>
            <button class="tab-btn @(activeTab == "financials" ? "active" : "")" @onclick='() => SwitchTab("financials")'>Financials</button>
            <button class="tab-btn @(activeTab == "valuation" ? "active" : "")" @onclick='() => SwitchTab("valuation")'>Valuation</button>
            <button class="tab-btn @(activeTab == "analyst" ? "active" : "")" @onclick='() => SwitchTab("analyst")'>Analyst</button>
            <button class="tab-btn @(activeTab == "compare" ? "active" : "")" @onclick='() => SwitchTab("compare")'>Compare</button>
        </div>
    </div>

    <div class="fa-content">
        @if (activeTab == "overview")
        {
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label>Symbol</label>
                        <input type="text" @bind="symbol" @bind:event="oninput" placeholder="Enter symbol (e.g., AAPL)" />
                    </div>
                    <button class="btn-primary" @onclick="GetOverview" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Analyze")
                    </button>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <p>Fetching company overview...</p>
                </div>
            }
            else if (overviewResult != null)
            {
                <div class="results-card">
                    <h3>@overviewResult.CompanyName (@overviewResult.Symbol)</h3>
                    
                    <div class="info-row">
                        <span class="info-label">Industry</span>
                        <span class="info-value">@overviewResult.Industry</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Sector</span>
                        <span class="info-value">@overviewResult.Sector</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Exchange</span>
                        <span class="info-value">@overviewResult.Exchange</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Country</span>
                        <span class="info-value">@overviewResult.Country</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">CEO</span>
                        <span class="info-value">@overviewResult.Ceo</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Employees</span>
                        <span class="info-value">@overviewResult.Employees.ToString("N0")</span>
                    </div>
                    <div class="info-row">
                        <span class="info-label">Website</span>
                        <span class="info-value">@overviewResult.Website</span>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(overviewResult.Description))
                    {
                        <div class="description-text">
                            @overviewResult.Description
                        </div>
                    }
                </div>

                <div class="results-card">
                    <h3>Key Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Market Cap</div>
                            <div class="metric-value">$@FormatLargeNumber(overviewResult.MarketCap)</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">P/E Ratio</div>
                            <div class="metric-value">@overviewResult.PeRatio.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">PEG Ratio</div>
                            <div class="metric-value">@overviewResult.PegRatio.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">EPS</div>
                            <div class="metric-value">$@overviewResult.Eps.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Beta</div>
                            <div class="metric-value">@overviewResult.Beta.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Dividend Yield</div>
                            <div class="metric-value">@((overviewResult.DividendYield * 100).ToString("F2"))%</div>
                        </div>
                    </div>
                </div>

                <div class="results-card">
                    <h3>Profitability Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Profit Margin</div>
                            <div class="metric-value positive">@((overviewResult.ProfitMargin * 100).ToString("F2"))%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Operating Margin</div>
                            <div class="metric-value positive">@((overviewResult.OperatingMarginTTM * 100).ToString("F2"))%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">ROA</div>
                            <div class="metric-value positive">@((overviewResult.ReturnOnAssetsTTM * 100).ToString("F2"))%</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">ROE</div>
                            <div class="metric-value positive">@((overviewResult.ReturnOnEquityTTM * 100).ToString("F2"))%</div>
                        </div>
                    </div>
                </div>

                <div class="results-card">
                    <h3>Growth Metrics</h3>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Quarterly Revenue Growth (YOY)</div>
                            <div class="metric-value @(overviewResult.QuarterlyRevenueGrowthYOY > 0 ? "positive" : "negative")">
                                @((overviewResult.QuarterlyRevenueGrowthYOY * 100).ToString("F2"))%
                            </div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Quarterly Earnings Growth (YOY)</div>
                            <div class="metric-value @(overviewResult.QuarterlyEarningsGrowthYOY > 0 ? "positive" : "negative")">
                                @((overviewResult.QuarterlyEarningsGrowthYOY * 100).ToString("F2"))%
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else if (activeTab == "financials")
        {
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label>Symbol</label>
                        <input type="text" @bind="symbol" @bind:event="oninput" placeholder="Enter symbol (e.g., AAPL)" />
                    </div>
                    <button class="btn-primary" @onclick="GetFinancials" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Get Financials")
                    </button>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <p>Fetching financial statements...</p>
                </div>
            }
            else if (financialsResult != null)
            {
                <div class="results-card">
                    <h3>Financial Statements for @financialsResult.Symbol</h3>
                    <p class="description-text">
                        Financial statements data including income statements, balance sheets, and cash flow statements.
                        Last updated: @financialsResult.LastUpdated.ToString("yyyy-MM-dd HH:mm")
                    </p>
                    
                    @if (financialsResult.IncomeStatements != null && financialsResult.IncomeStatements.Any())
                    {
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem;">Income Statements</h4>
                            <div class="table-container">
                                <table class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Period</th>
                                            <th>Revenue</th>
                                            <th>Gross Profit</th>
                                            <th>Operating Income</th>
                                            <th>Net Income</th>
                                            <th>EPS</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var statement in financialsResult.IncomeStatements.OrderByDescending(s => s.Date))
                                        {
                                            <tr>
                                                <td>@statement.Date</td>
                                                <td>@statement.Period</td>
                                                <td>$@statement.Revenue.ToString("N0")</td>
                                                <td>$@statement.GrossProfit.ToString("N0")</td>
                                                <td>$@statement.OperatingIncome.ToString("N0")</td>
                                                <td>$@statement.NetIncome.ToString("N0")</td>
                                                <td>$@statement.EPS.ToString("F2")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    
                    @if (financialsResult.BalanceSheets != null && financialsResult.BalanceSheets.Any())
                    {
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem;">Balance Sheets</h4>
                            <div class="table-container">
                                <table class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Period</th>
                                            <th>Total Assets</th>
                                            <th>Total Liabilities</th>
                                            <th>Total Equity</th>
                                            <th>Cash & Equivalents</th>
                                            <th>Total Debt</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var statement in financialsResult.BalanceSheets.OrderByDescending(s => s.Date))
                                        {
                                            <tr>
                                                <td>@statement.Date</td>
                                                <td>@statement.Period</td>
                                                <td>$@statement.TotalAssets.ToString("N0")</td>
                                                <td>$@statement.TotalLiabilities.ToString("N0")</td>
                                                <td>$@statement.TotalEquity.ToString("N0")</td>
                                                <td>$@statement.CashAndEquivalents.ToString("N0")</td>
                                                <td>$@statement.TotalDebt.ToString("N0")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                    
                    @if (financialsResult.CashFlowStatements != null && financialsResult.CashFlowStatements.Any())
                    {
                        <div style="margin-top: 1.5rem;">
                            <h4 style="color: #9ca3af; font-size: 0.875rem; margin-bottom: 0.5rem;">Cash Flow Statements</h4>
                            <div class="table-container">
                                <table class="financial-table">
                                    <thead>
                                        <tr>
                                            <th>Date</th>
                                            <th>Period</th>
                                            <th>Operating CF</th>
                                            <th>Investing CF</th>
                                            <th>Financing CF</th>
                                            <th>Free Cash Flow</th>
                                            <th>Net Change in Cash</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var statement in financialsResult.CashFlowStatements.OrderByDescending(s => s.Date))
                                        {
                                            <tr>
                                                <td>@statement.Date</td>
                                                <td>@statement.Period</td>
                                                <td>$@statement.OperatingCashFlow.ToString("N0")</td>
                                                <td>$@statement.InvestingCashFlow.ToString("N0")</td>
                                                <td>$@statement.FinancingCashFlow.ToString("N0")</td>
                                                <td>$@statement.FreeCashFlow.ToString("N0")</td>
                                                <td>$@statement.NetChangeInCash.ToString("N0")</td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    }
                </div>
            }
        }
        else if (activeTab == "valuation")
        {
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label>Symbol</label>
                        <input type="text" @bind="symbol" @bind:event="oninput" placeholder="Enter symbol (e.g., AAPL)" />
                    </div>
                    <button class="btn-primary" @onclick="GetValuation" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Get Valuation")
                    </button>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <p>Analyzing valuation...</p>
                </div>
            }
            else if (valuationResult != null)
            {
                <div class="results-card">
                    <h3>Valuation Analysis for @valuationResult.Symbol</h3>
                    
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Current Price</div>
                            <div class="metric-value">$@valuationResult.CurrentPrice.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Intrinsic Value</div>
                            <div class="metric-value">$@valuationResult.IntrinsicValue.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Fair Value</div>
                            <div class="metric-value">$@valuationResult.FairValue.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Recommendation</div>
                            <div class="metric-value @GetRecommendationClass(valuationResult.Recommendation)">
                                @valuationResult.Recommendation
                            </div>
                        </div>
                    </div>

                    @if (!string.IsNullOrWhiteSpace(valuationResult.AIAnalysis))
                    {
                        <div class="description-text" style="margin-top: 1.5rem;">
                            <h4 style="color: #9ca3af; margin-bottom: 1rem; font-size: 1.1rem;">AI Valuation Analysis</h4>
                            <div style="white-space: pre-wrap; line-height: 1.8;">@((MarkupString)System.Text.RegularExpressions.Regex.Replace(valuationResult.AIAnalysis, @"\*\*(.+?)\*\*", "<strong>$1</strong>"))</div>
                        </div>
                    }
                    else if (!string.IsNullOrWhiteSpace(valuationResult.Reasoning))
                    {
                        <div class="description-text">
                            <strong>Quick Analysis:</strong><br />
                            @valuationResult.Reasoning
                        </div>
                    }
                </div>

                @if (valuationResult.ValuationMetrics != null)
                {
                    <div class="results-card">
                        <h3>Valuation Metrics</h3>
                        <div class="metric-grid">
                            @foreach (var metric in valuationResult.ValuationMetrics)
                            {
                                <div class="metric-item">
                                    <div class="metric-label">@FormatMetricName(metric.Key)</div>
                                    <div class="metric-value">@FormatMetricValue(metric.Value)</div>
                                </div>
                            }
                        </div>
                    </div>
                }
            }
        }
        else if (activeTab == "analyst")
        {
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label>Symbol</label>
                        <input type="text" @bind="symbol" @bind:event="oninput" placeholder="Enter symbol (e.g., AAPL)" />
                    </div>
                    <button class="btn-primary" @onclick="GetAnalyst" disabled="@isLoading">
                        @(isLoading ? "Loading..." : "Get Analyst Data")
                    </button>
                </div>
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <p>Fetching analyst data...</p>
                </div>
            }
            else if (analystResult != null)
            {
                <!-- Main Rating Card -->
                <div class="results-card">
                    <h3>Quantitative Analyst Analysis for @analystResult.Symbol</h3>
                    
                    @if (analystResult.Estimates != null)
                    {
                        var estimates = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(System.Text.Json.JsonSerializer.Serialize(analystResult.Estimates));
                        var quantScore = estimates.GetProperty("quantitativeScore").GetInt32();
                        var ratingClass = quantScore >= 70 ? "positive" : (quantScore >= 40 ? "neutral" : "negative");
                        
                        <div style="display: flex; align-items: center; gap: 2rem; margin-bottom: 2rem; padding: 1.5rem; background: rgba(31, 41, 55, 0.5); border-radius: 8px;">
                            <div style="flex: 1;">
                                <div style="font-size: 3rem; font-weight: bold; color: var(--accent-color);">@quantScore/100</div>
                                <div style="color: #9ca3af; margin-top: 0.5rem;">Quantitative Score</div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-size: 2rem; font-weight: bold;" class="@ratingClass">@analystResult.ConsensusRating</div>
                                <div style="color: #9ca3af; margin-top: 0.5rem;">Consensus Rating</div>
                            </div>
                        </div>
                    }
                    
                    <!-- Target Prices -->
                    <h4 style="color: #9ca3af; margin-bottom: 1rem;">Price Targets</h4>
                    <div class="metric-grid">
                        <div class="metric-item">
                            <div class="metric-label">Average Target</div>
                            <div class="metric-value" style="color: var(--accent-color);">$@analystResult.AverageTargetPrice.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">High Target</div>
                            <div class="metric-value positive">$@analystResult.HighTargetPrice.ToString("F2")</div>
                        </div>
                        <div class="metric-item">
                            <div class="metric-label">Low Target</div>
                            <div class="metric-value">$@analystResult.LowTargetPrice.ToString("F2")</div>
                        </div>
                    </div>

                    <!-- Rating Distribution -->
                    <div style="margin-top: 2rem;">
                        <h4 style="color: #9ca3af; margin-bottom: 1rem;">Rating Distribution</h4>
                        <div class="metric-grid" style="grid-template-columns: repeat(5, 1fr);">
                            <div class="metric-item">
                                <div class="metric-label">Strong Buy</div>
                                <div class="metric-value positive">@analystResult.AnalystRatingStrongBuy</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Buy</div>
                                <div class="metric-value positive">@analystResult.BuyRatings</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Hold</div>
                                <div class="metric-value neutral">@analystResult.HoldRatings</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Sell</div>
                                <div class="metric-value negative">@analystResult.SellRatings</div>
                            </div>
                            <div class="metric-item">
                                <div class="metric-label">Strong Sell</div>
                                <div class="metric-value negative">@analystResult.AnalystRatingStrongSell</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Quantitative Scores Breakdown -->
                @if (analystResult.Estimates != null)
                {
                    var estimates = System.Text.Json.JsonSerializer.Deserialize<System.Text.Json.JsonElement>(System.Text.Json.JsonSerializer.Serialize(analystResult.Estimates));
                    
                    <div class="results-card">
                        <h3>Score Breakdown</h3>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem;">@estimates.GetProperty("methodology").GetString()</p>
                        
                        <div style="display: grid; gap: 1rem;">
                            @{
                                var scores = new[] {
                                    (Label: "Valuation Score", Value: estimates.GetProperty("valuationScore").GetInt32(), Max: 20),
                                    (Label: "Profitability Score", Value: estimates.GetProperty("profitabilityScore").GetInt32(), Max: 20),
                                    (Label: "Growth Score", Value: estimates.GetProperty("growthScore").GetInt32(), Max: 20),
                                    (Label: "Financial Health Score", Value: estimates.GetProperty("financialHealthScore").GetInt32(), Max: 20),
                                    (Label: "Momentum Score", Value: estimates.GetProperty("momentumScore").GetInt32(), Max: 20)
                                };
                            }
                            
                            @foreach (var score in scores)
                            {
                                var percentage = (score.Value * 100.0 / score.Max);
                                var barColor = percentage >= 70 ? "#10b981" : (percentage >= 50 ? "#f59e0b" : "#ef4444");
                                
                                <div>
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <span style="color: #e5e7eb;">@score.Label</span>
                                        <span style="color: var(--accent-color); font-weight: bold;">@score.Value/@score.Max</span>
                                    </div>
                                    <div style="width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden;">
                                        <div style="width: @percentage%; height: 100%; background: @barColor; transition: width 0.3s ease;"></div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>

                    <!-- AI Analysis -->
                    @if (estimates.TryGetProperty("aiAnalysis", out var aiAnalysis) && !string.IsNullOrEmpty(aiAnalysis.GetString()))
                    {
                        <div class="results-card">
                            <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                <span style="font-size: 1.5rem;">ðŸ¤–</span>
                                AI-Powered Analysis
                            </h3>
                            <div style="color: #d1d5db; line-height: 1.8; white-space: pre-wrap; padding: 1rem; background: rgba(31, 41, 55, 0.5); border-radius: 8px; border-left: 4px solid var(--accent-color);">@aiAnalysis.GetString()</div>
                        </div>
                    }
                }
            }
        }
        else if (activeTab == "compare")
        {
            <div class="input-section">
                <div class="input-group">
                    <div class="input-field">
                        <label>Add Symbol to Compare</label>
                        <input type="text" @bind="newSymbol" @bind:event="oninput" placeholder="Enter symbol" 
                               @onkeypress="@(e => { if (e.Key == "Enter") AddSymbol(); })" />
                    </div>
                    <button class="btn-primary" @onclick="AddSymbol">Add Symbol</button>
                </div>

                @if (compareSymbols.Any())
                {
                    <div class="symbol-chips-container" style="margin-top: 1rem;">
                        @foreach (var sym in compareSymbols)
                        {
                            <div class="symbol-chip">
                                @sym
                                <button class="remove-chip" @onclick="() => RemoveSymbol(sym)">Ã—</button>
                            </div>
                        }
                    </div>

                    <button class="btn-primary" @onclick="CompareCompanies" disabled="@(isLoading || compareSymbols.Count < 2)" style="margin-top: 1rem;">
                        @(isLoading ? "Loading..." : "Compare Companies")
                    </button>
                }
            </div>

            @if (isLoading)
            {
                <div class="loading">
                    <p>Comparing companies...</p>
                </div>
            }
            else if (compareResult != null && compareResult.Comparisons != null)
            {
                <div class="results-card">
                    <h3>Company Comparison</h3>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>Metric</th>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <th>@comparison.Symbol</th>
                                }
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>Market Cap</td>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <td>$@FormatLargeNumber(comparison.MarketCap)</td>
                                }
                            </tr>
                            <tr>
                                <td>P/E Ratio</td>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <td>@comparison.PeRatio.ToString("F2")</td>
                                }
                            </tr>
                            <tr>
                                <td>EPS</td>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <td>$@comparison.Eps.ToString("F2")</td>
                                }
                            </tr>
                            <tr>
                                <td>ROE</td>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <td>@((comparison.Roe * 100).ToString("F2"))%</td>
                                }
                            </tr>
                            <tr>
                                <td>Profit Margin</td>
                                @foreach (var comparison in compareResult.Comparisons)
                                {
                                    <td>@((comparison.ProfitMargin * 100).ToString("F2"))%</td>
                                }
                            </tr>
                        </tbody>
                    </table>
                </div>
            }
        }
    </div>
</div>

@code {
    private string activeTab = "overview";
    private bool isLoading = false;

    // Input fields
    private string symbol = "AAPL";
    private string newSymbol = "";
    private List<string> compareSymbols = new();

    // Results
    private CompanyOverviewResponse? overviewResult;
    private FinancialsResponse? financialsResult;
    private ValuationResponse? valuationResult;
    private AnalystResponse? analystResult;
    private CompareResponse? compareResult;

    private void SwitchTab(string tab)
    {
        activeTab = tab;
        ClearResults();
    }

    private void ClearResults()
    {
        overviewResult = null;
        financialsResult = null;
        valuationResult = null;
        analystResult = null;
        compareResult = null;
    }

    private string SanitizeSymbol(string inputSymbol)
    {
        return inputSymbol.Contains(':') 
            ? inputSymbol.Split(':')[1].ToUpper() 
            : inputSymbol.ToUpper();
    }

    private async Task GetOverview()
    {
        if (string.IsNullOrWhiteSpace(symbol)) return;

        isLoading = true;
        try
        {
            var cleanSymbol = SanitizeSymbol(symbol);
            var response = await Http.PostAsJsonAsync("/api/fundamentalanalysis/overview", new
            {
                Symbol = cleanSymbol
            });

            if (response.IsSuccessStatusCode)
            {
                overviewResult = await response.Content.ReadFromJsonAsync<CompanyOverviewResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetFinancials()
    {
        if (string.IsNullOrWhiteSpace(symbol)) return;

        isLoading = true;
        try
        {
            var cleanSymbol = SanitizeSymbol(symbol);
            var response = await Http.PostAsJsonAsync("/api/fundamentalanalysis/financials", new
            {
                Symbol = cleanSymbol
            });

            if (response.IsSuccessStatusCode)
            {
                financialsResult = await response.Content.ReadFromJsonAsync<FinancialsResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetValuation()
    {
        if (string.IsNullOrWhiteSpace(symbol)) return;

        isLoading = true;
        try
        {
            var cleanSymbol = SanitizeSymbol(symbol);
            var response = await Http.PostAsJsonAsync("/api/fundamentalanalysis/valuation", new
            {
                Symbol = cleanSymbol
            });

            if (response.IsSuccessStatusCode)
            {
                valuationResult = await response.Content.ReadFromJsonAsync<ValuationResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task GetAnalyst()
    {
        if (string.IsNullOrWhiteSpace(symbol)) return;

        isLoading = true;
        try
        {
            var cleanSymbol = SanitizeSymbol(symbol);
            var response = await Http.PostAsJsonAsync("/api/fundamentalanalysis/analyst", new
            {
                Symbol = cleanSymbol
            });

            if (response.IsSuccessStatusCode)
            {
                analystResult = await response.Content.ReadFromJsonAsync<AnalystResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private void AddSymbol()
    {
        if (!string.IsNullOrWhiteSpace(newSymbol))
        {
            var cleanSymbol = SanitizeSymbol(newSymbol);
            if (!compareSymbols.Contains(cleanSymbol))
            {
                compareSymbols.Add(cleanSymbol);
                newSymbol = "";
            }
        }
    }

    private void RemoveSymbol(string sym)
    {
        compareSymbols.Remove(sym);
    }

    private async Task CompareCompanies()
    {
        if (!compareSymbols.Any()) return;

        isLoading = true;
        try
        {
            var response = await Http.PostAsJsonAsync("/api/fundamentalanalysis/compare", new
            {
                Symbols = compareSymbols
            });

            if (response.IsSuccessStatusCode)
            {
                compareResult = await response.Content.ReadFromJsonAsync<CompareResponse>();
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string FormatLargeNumber(double number)
    {
        if (number >= 1_000_000_000_000)
            return $"{(number / 1_000_000_000_000):F2}T";
        if (number >= 1_000_000_000)
            return $"{(number / 1_000_000_000):F2}B";
        if (number >= 1_000_000)
            return $"{(number / 1_000_000):F2}M";
        return number.ToString("N0");
    }

    private string FormatMetricName(string key)
    {
        return System.Text.RegularExpressions.Regex.Replace(key, "([a-z])([A-Z])", "$1 $2");
    }

    private string FormatMetricValue(object value)
    {
        if (value is double d)
            return d.ToString("F2");
        if (value is decimal dec)
            return dec.ToString("F2");
        return value?.ToString() ?? "N/A";
    }

    private string GetRecommendationClass(string recommendation)
    {
        return recommendation?.ToLower() switch
        {
            "buy" or "strong buy" => "positive",
            "sell" or "strong sell" => "negative",
            _ => ""
        };
    }

    // Response models
    public class CompanyOverviewResponse
    {
        public string Symbol { get; set; } = string.Empty;
        public string CompanyName { get; set; } = string.Empty;
        public string Description { get; set; } = string.Empty;
        public string Industry { get; set; } = string.Empty;
        public string Sector { get; set; } = string.Empty;
        public string Exchange { get; set; } = string.Empty;
        public string Country { get; set; } = string.Empty;
        public string Website { get; set; } = string.Empty;
        public string Ceo { get; set; } = string.Empty;
        public long Employees { get; set; }
        public double MarketCap { get; set; }
        public double PeRatio { get; set; }
        public double PegRatio { get; set; }
        public double Eps { get; set; }
        public double Beta { get; set; }
        public double DividendYield { get; set; }
        public double ProfitMargin { get; set; }
        public double OperatingMarginTTM { get; set; }
        public double ReturnOnAssetsTTM { get; set; }
        public double ReturnOnEquityTTM { get; set; }
        public double QuarterlyRevenueGrowthYOY { get; set; }
        public double QuarterlyEarningsGrowthYOY { get; set; }
    }

    public class FinancialsResponse
    {
        public string Symbol { get; set; } = string.Empty;
        public List<IncomeStatement> IncomeStatements { get; set; } = new();
        public List<BalanceSheet> BalanceSheets { get; set; } = new();
        public List<CashFlowStatement> CashFlowStatements { get; set; } = new();
        public DateTime LastUpdated { get; set; }
    }

    public class IncomeStatement
    {
        public string Date { get; set; } = string.Empty;
        public string Period { get; set; } = string.Empty;
        public long Revenue { get; set; }
        public long CostOfRevenue { get; set; }
        public long GrossProfit { get; set; }
        public long OperatingExpenses { get; set; }
        public long OperatingIncome { get; set; }
        public long NetIncome { get; set; }
        public decimal EPS { get; set; }
        public decimal EPSDiluted { get; set; }
    }

    public class BalanceSheet
    {
        public string Date { get; set; } = string.Empty;
        public string Period { get; set; } = string.Empty;
        public long TotalAssets { get; set; }
        public long TotalLiabilities { get; set; }
        public long TotalEquity { get; set; }
        public long CashAndEquivalents { get; set; }
        public long TotalCurrentAssets { get; set; }
        public long TotalCurrentLiabilities { get; set; }
        public long LongTermDebt { get; set; }
        public long TotalDebt { get; set; }
    }

    public class CashFlowStatement
    {
        public string Date { get; set; } = string.Empty;
        public string Period { get; set; } = string.Empty;
        public long OperatingCashFlow { get; set; }
        public long InvestingCashFlow { get; set; }
        public long FinancingCashFlow { get; set; }
        public long FreeCashFlow { get; set; }
        public long CapitalExpenditure { get; set; }
        public long NetChangeInCash { get; set; }
    }

    public class ValuationResponse
    {
        public string Symbol { get; set; } = string.Empty;
        public double CurrentPrice { get; set; }
        public double IntrinsicValue { get; set; }
        public double FairValue { get; set; }
        public Dictionary<string, object> ValuationMetrics { get; set; } = new();
        public string Recommendation { get; set; } = string.Empty;
        public string Reasoning { get; set; } = string.Empty;
        public string AIAnalysis { get; set; } = string.Empty;
    }

    public class AnalystResponse
    {
        public string Symbol { get; set; } = string.Empty;
        public string ConsensusRating { get; set; } = string.Empty;
        public double AverageTargetPrice { get; set; }
        public double HighTargetPrice { get; set; }
        public double LowTargetPrice { get; set; }
        public int NumberOfAnalysts { get; set; }
        public int BuyRatings { get; set; }
        public int HoldRatings { get; set; }
        public int SellRatings { get; set; }
        public int AnalystRatingStrongBuy { get; set; }
        public int AnalystRatingStrongSell { get; set; }
        public object? Estimates { get; set; }
    }

    public class CompareResponse
    {
        public List<CompanyComparison> Comparisons { get; set; } = new();
    }

    public class CompanyComparison
    {
        public string Symbol { get; set; } = string.Empty;
        public double MarketCap { get; set; }
        public double PeRatio { get; set; }
        public double Eps { get; set; }
        public double Roe { get; set; }
        public double ProfitMargin { get; set; }
    }
}
